<!doctype html><html lang=en-us><head><meta charset=utf-8><title itemprop=name>How to use Sticky Sessions | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro</title><meta name=twitter:title content="How to use Sticky Sessions | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta itemprop=name content="How to use Sticky Sessions | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta name=application-name content="How to use Sticky Sessions | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta property="og:site_name" content="Tetrate Istio Distro"><meta name=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta itemprop=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta name=twitter:description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:locale" content="en"><meta name=language content="En"><link rel=alternate hreflang=en href=/istio-in-practice/sticky-sessions/><link rel=alternate hreflang=zh href=/zh/istio-in-practice/sticky-sessions/><meta property="og:updated_time" content="2021-01-01T11:02:05+0600"><link rel=sitemap type=application/xml title=Sitemap href=/sitemap.xml><link href=/istio-in-practice/sticky-sessions/index.xml rel=alternate type=application/rss+xml title="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"><link href=/istio-in-practice/sticky-sessions/index.xml rel=feed type=application/rss+xml title="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"><meta property="og:type" content="website"><meta name=author content="Tetrate"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","url":"https:\/\/istio.tetratelabs.io\/istio-in-practice\/sticky-sessions\/","sameAs":["","https:\/\/github.com\/tetratelabs\/getmesh"],"name":"Tetrate Istio Distro | Simple, safe enterprise-grade Istio","logo":"https://getistio.io/images/getistio-by-tetrate-logo.png"}</script><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@tetrateio"><meta name=twitter:creator content="@tetrateio"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-P3J9XNBME4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-P3J9XNBME4')</script><link rel=preload href=/plugins/themify-icons/themify-icons.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css></noscript><link rel=preload href=/plugins/search/auto-complete.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/search/auto-complete.css></noscript><link rel=preload href=/plugins/featherlight/featherlight.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/featherlight/featherlight.min.css></noscript><link rel=preload href=/css/bootstrap/bootstrap.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css></noscript><link rel=preload href=/scss/style.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/scss/style.css></noscript><link rel="shortcut icon" href=/images/getistio-favicon.png type=image/x-icon><link rel=icon href=/images/getistio-favicon.png type=image/x-icon><meta property="og:title" content="How to use Sticky Sessions"><meta property="og:description" content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:type" content="website"><meta property="og:url" content="https://istio.tetratelabs.io/istio-in-practice/sticky-sessions/"><meta property="og:image" content="https://istio.tetratelabs.io/images/twitter-card-new.png"><script async defer src=/js/turbolinks.min.js></script></head><body><header class="sticky-top navigation"><div class=my-container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><div class=navbar-brand-container><a class=navbar-brand href=/><img class="img-fluid logo-width" src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a class=github-button href=https://github.com/tetratelabs/getistio data-icon=octicon-star aria-label="Star tetratelabs/getmesh on GitHub">Star</a></div><button aria-label=Menu class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h4 text-white"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto align-items-center"><li class=nav-item><a class=nav-link href=/getmesh-cli/>Docs</a></li><li class=nav-item><a class=nav-link href=/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=/community-events/>Community</a></li><li class=nav-item><a class=nav-link href=https://academy.tetrate.io target=_blank>Training</a></li><li class=nav-item><a class=nav-link href=https://func-e.io/ target=_blank>func-e</a></li><li class=nav-item><a class=nav-link href=https://www.istio.io/ target=_blank>Istio.io</a></li><li class=nav-link><select class=nav-item id=select-language onchange="location=this.value"><option id=en value=/istio-in-practice/sticky-sessions/ selected>En</option><option id=zh value=/zh/istio-in-practice/sticky-sessions/>中文</option></select></li></ul><div class="d-lg-none d-block"><a href=/download class="btn btn-sm btn-primary ml-lg-4">download</a></div></div><div class="d-lg-flex d-none"><a href=/download class="btn btn-sm btn-primary ml-lg-4">Download</a></div></nav></div></header><section class=pt-5><div class="container d-block d-sm-block d-lg-none"><div class="row justify-content-center mb-4"><div><button onclick=dropdownFunction() class="btn btn-primary dropdown-toggle nav-dropdown">Browse Docs
<span class=caret></span></button><ul id=mobileDropdownMenu class=dropdown-content><li data-nav-id=/introduction/ title=Introduction class="sidelist my-2"><a href=/introduction/>Introduction</a></li><li data-nav-id=/quickstart/ title="TID Quickstart" class="sidelist my-2"><a href=/quickstart/>TID Quickstart</a></li><li data-nav-id=/mgmt-tasks/ title="Common Management Tasks" class="sidelist my-2"><a href=/mgmt-tasks/>Common Management Tasks</a></li><li data-nav-id=/getmesh-cli/ title="GetMesh Documentation" class="sidelist my-2"><a href=/getmesh-cli/>GetMesh Documentation</a></li><li data-nav-id=/istio-in-practice/ title="Istio in Practice" class="sidelist parent my-2"><a href=/istio-in-practice/>Istio in Practice</a></li><li data-nav-id=/istio-ca-certs-integrations/ title="Istio CA Certs Integration" class="sidelist my-2"><a href=/istio-ca-certs-integrations/>Istio CA Certs Integration</a></li><li data-nav-id=/istio-cheatsheet/ title="Istio Hints and Tips" class="sidelist my-2"><a href=/istio-cheatsheet/>Istio Hints and Tips</a></li><li data-nav-id=/helm/ title="Helm Chart Deployment" class="sidelist my-2"><a href=/helm/>Helm Chart Deployment</a></li><li data-nav-id=/download/ title=Downloads class="sidelist my-2"><a href=/download/>Downloads</a></li><li data-nav-id=/faq/ title=FAQs class="sidelist my-2"><a href=/faq/>FAQs</a></li><li data-nav-id=/community/ title=Community class="sidelist my-2"><a href=/community/>Community</a></li><li data-nav-id=/fips-request/ title="FIPS Download Request" class="sidelist my-2"><a href=/fips-request/>FIPS Download Request</a></li></ul></div></div></div><div class="container shadow section-sm rounded docs-content"><div class=row><div class="col-lg-3 d-none d-md-none d-lg-block"><ul class=sidenav><li data-nav-id=/introduction/ title=Introduction class=sidelist><a href=/introduction/>Introduction</a><ul><li data-nav-id=/introduction/intro/ title class=sidelist><a href=/introduction/intro/></a></ul></li><li data-nav-id=/quickstart/ title="TID Quickstart" class=sidelist><a href=/quickstart/>TID Quickstart</a><ul><li data-nav-id=/quickstart/start/ title class=sidelist><a href=/quickstart/start/></a></ul></li><li data-nav-id=/mgmt-tasks/ title="Common Management Tasks" class=sidelist><a href=/mgmt-tasks/>Common Management Tasks</a><ul><li data-nav-id=/mgmt-tasks/install-istio-updates/ title="Install Istio Updates" class=sidelist><a href=/mgmt-tasks/install-istio-updates/>Install Istio Updates</a><li data-nav-id=/mgmt-tasks/install-istio-and-manage-multiple-istioctl/ title="Manage multiple istioctl" class=sidelist><a href=/mgmt-tasks/install-istio-and-manage-multiple-istioctl/>Manage multiple istioctl</a><li data-nav-id=/mgmt-tasks/config-validation/ title="Config Validation" class=sidelist><a href=/mgmt-tasks/config-validation/>Config Validation</a></ul></li><li data-nav-id=/getmesh-cli/ title="GetMesh Documentation" class=sidelist><a href=/getmesh-cli/>GetMesh Documentation</a><ul><li data-nav-id=/getmesh-cli/install/ title="Install GetMesh and Istio" class=sidelist><a href=/getmesh-cli/install/>Install GetMesh and Istio</a><ul><li data-nav-id=/getmesh-cli/install/install-istio/ title="Install Istio" class=sidelist><a href=/getmesh-cli/install/install-istio/>Install Istio</a><ul><li data-nav-id=/getmesh-cli/install/install-istio/prepare-eks-cluster/ title="Prepare AWS EKS cluster" class=sidelist><a href=/getmesh-cli/install/install-istio/prepare-eks-cluster/>Prepare AWS EKS cluster</a><li data-nav-id=/getmesh-cli/install/install-istio/aks-tid-deployment/ title="Install Istio on Azure AKS" class=sidelist><a href=/getmesh-cli/install/install-istio/aks-tid-deployment/>Install Istio on Azure AKS</a><li data-nav-id=/getmesh-cli/install/install-istio/eks-addon/ title="Install Istio in EKS with add-on" class=sidelist><a href=/getmesh-cli/install/install-istio/eks-addon/>Install Istio in EKS with add-on</a><li data-nav-id=/getmesh-cli/install/install-istio/deploy-gateway/ title="Deploy Istio Gateway in EKS" class=sidelist><a href=/getmesh-cli/install/install-istio/deploy-gateway/>Deploy Istio Gateway in EKS</a></ul></li><li data-nav-id=/getmesh-cli/install/install-and-update/ title="GetMesh installation and update" class=sidelist><a href=/getmesh-cli/install/install-and-update/>GetMesh installation and update</a><li data-nav-id=/getmesh-cli/install/post-install/ title="Once you've installed Istio" class=sidelist><a href=/getmesh-cli/install/post-install/>Once you've installed Istio</a></ul></li><li data-nav-id=/getmesh-cli/reference/ title=Reference class=sidelist><a href=/getmesh-cli/reference/>Reference</a><ul><li data-nav-id=/getmesh-cli/reference/getmesh/ title=GetMesh class=sidelist><a href=/getmesh-cli/reference/getmesh/>GetMesh</a><li data-nav-id=/getmesh-cli/reference/getmesh_check-upgrade/ title="getmesh check-upgrade" class=sidelist><a href=/getmesh-cli/reference/getmesh_check-upgrade/>getmesh check-upgrade</a><li data-nav-id=/getmesh-cli/reference/getmesh_config-validate/ title="getmesh config-validate" class=sidelist><a href=/getmesh-cli/reference/getmesh_config-validate/>getmesh config-validate</a><li data-nav-id=/getmesh-cli/reference/getmesh_default-hub/ title="getmesh default-hub" class=sidelist><a href=/getmesh-cli/reference/getmesh_default-hub/>getmesh default-hub</a><li data-nav-id=/getmesh-cli/reference/getmesh_fetch/ title="getmesh fetch" class=sidelist><a href=/getmesh-cli/reference/getmesh_fetch/>getmesh fetch</a><li data-nav-id=/getmesh-cli/reference/getmesh_gen-ca/ title="getmesh gen-ca" class=sidelist><a href=/getmesh-cli/reference/getmesh_gen-ca/>getmesh gen-ca</a><li data-nav-id=/getmesh-cli/reference/getmesh_help/ title="getmesh help" class=sidelist><a href=/getmesh-cli/reference/getmesh_help/>getmesh help</a><li data-nav-id=/getmesh-cli/reference/getmesh_istioctl/ title="getmesh istioctl" class=sidelist><a href=/getmesh-cli/reference/getmesh_istioctl/>getmesh istioctl</a><li data-nav-id=/getmesh-cli/reference/getmesh_list/ title="getmesh list" class=sidelist><a href=/getmesh-cli/reference/getmesh_list/>getmesh list</a><li data-nav-id=/getmesh-cli/reference/getmesh_prune/ title="getmesh prune" class=sidelist><a href=/getmesh-cli/reference/getmesh_prune/>getmesh prune</a><li data-nav-id=/getmesh-cli/reference/getmesh_show/ title="getmesh show" class=sidelist><a href=/getmesh-cli/reference/getmesh_show/>getmesh show</a><li data-nav-id=/getmesh-cli/reference/getmesh_switch/ title="getmesh switch" class=sidelist><a href=/getmesh-cli/reference/getmesh_switch/>getmesh switch</a><li data-nav-id=/getmesh-cli/reference/getmesh_version/ title="getmesh version" class=sidelist><a href=/getmesh-cli/reference/getmesh_version/>getmesh version</a></ul></li></ul></li><li data-nav-id=/istio-in-practice/ title="Istio in Practice" class="sidelist parent"><a href=/istio-in-practice/>Istio in Practice</a><ul><li data-nav-id=/istio-in-practice/prerequisites/ title=Prerequisites class=sidelist><a href=/istio-in-practice/prerequisites/>Prerequisites</a><li data-nav-id=/istio-in-practice/zero-downtime-releases/ title="How to do Zero-Downtime Releases" class=sidelist><a href=/istio-in-practice/zero-downtime-releases/>How to do Zero-Downtime Releases</a><li data-nav-id=/istio-in-practice/traffic-mirroring/ title="How to use Traffic Mirroring" class=sidelist><a href=/istio-in-practice/traffic-mirroring/>How to use Traffic Mirroring</a><li data-nav-id=/istio-in-practice/sticky-sessions/ title="How to use Sticky Sessions" class="sidelist parent active"><a href=/istio-in-practice/sticky-sessions/>How to use Sticky Sessions</a><li data-nav-id=/istio-in-practice/setting-up-ssl-certs/ title="How to set up SSL Certificates" class=sidelist><a href=/istio-in-practice/setting-up-ssl-certs/>How to set up SSL Certificates</a><li data-nav-id=/istio-in-practice/multiple-ingress-gateways/ title="How to Deploy Multiple Istio Ingress Gateways" class=sidelist><a href=/istio-in-practice/multiple-ingress-gateways/>How to Deploy Multiple Istio Ingress Gateways</a><li data-nav-id=/istio-in-practice/aws-cloudmap-integration/ title="Integrate AWS Cloud Map with Istio" class=sidelist><a href=/istio-in-practice/aws-cloudmap-integration/>Integrate AWS Cloud Map with Istio</a><li data-nav-id=/istio-in-practice/install-skywalking/ title="Integration with Apache SkyWalking" class=sidelist><a href=/istio-in-practice/install-skywalking/>Integration with Apache SkyWalking</a></ul></li><li data-nav-id=/istio-ca-certs-integrations/ title="Istio CA Certs Integration" class=sidelist><a href=/istio-ca-certs-integrations/>Istio CA Certs Integration</a><ul><li data-nav-id=/istio-ca-certs-integrations/acmpca-integration/ title="AWS Private CA Integration" class=sidelist><a href=/istio-ca-certs-integrations/acmpca-integration/>AWS Private CA Integration</a><li data-nav-id=/istio-ca-certs-integrations/gcp-cas-integration/ title="GCP CA Integration" class=sidelist><a href=/istio-ca-certs-integrations/gcp-cas-integration/>GCP CA Integration</a><li data-nav-id=/istio-ca-certs-integrations/cert-manager-integration/ title="cert-manager CA Integration" class=sidelist><a href=/istio-ca-certs-integrations/cert-manager-integration/>cert-manager CA Integration</a></ul></li><li data-nav-id=/istio-cheatsheet/ title="Istio Hints and Tips" class=sidelist><a href=/istio-cheatsheet/>Istio Hints and Tips</a><ul><li data-nav-id=/istio-cheatsheet/cheatsheet/ title class=sidelist><a href=/istio-cheatsheet/cheatsheet/></a></ul></li><li data-nav-id=/helm/ title="Helm Chart Deployment" class=sidelist><a href=/helm/>Helm Chart Deployment</a><ul><li data-nav-id=/helm/charts/ title class=sidelist><a href=/helm/charts/></a></ul></li><li data-nav-id=/download/ title=Downloads class=sidelist><a href=/download/>Downloads</a><ul><li data-nav-id=/download/downloads/ title class=sidelist><a href=/download/downloads/></a></ul></li><li data-nav-id=/faq/ title=FAQs class=sidelist><a href=/faq/>FAQs</a><ul><li data-nav-id=/faq/questions/ title class=sidelist><a href=/faq/questions/></a></ul></li><li data-nav-id=/community/ title=Community class=sidelist><a href=/community/>Community</a><ul><li data-nav-id=/community/event/getistio-inaugural/ title="What is GetIstio - Inaugural Community Meetup" class=sidelist><a href=/community/event/getistio-inaugural/>What is GetIstio - Inaugural Community Meetup</a><li data-nav-id=/community/event/istiocon-2021/ title="IstioCon 2021" class=sidelist><a href=/community/event/istiocon-2021/>IstioCon 2021</a><li data-nav-id=/community/event/getenvoy-deep-dive/ title="Effortless Envoy and WASM with GetEnvoy" class=sidelist><a href=/community/event/getenvoy-deep-dive/>Effortless Envoy and WASM with GetEnvoy</a><li data-nav-id=/community/event/getistio-deep-dive/ title="Istio the Easy Way with GetIstio" class=sidelist><a href=/community/event/getistio-deep-dive/>Istio the Easy Way with GetIstio</a><li data-nav-id=/community/event/tid-episode-003/ title="SSL Certificates in Istio Ingress Gateway" class=sidelist><a href=/community/event/tid-episode-003/>SSL Certificates in Istio Ingress Gateway</a><li data-nav-id=/community/event/tid-episode-004/ title="Deploying multiple Istio ingress gateways" class=sidelist><a href=/community/event/tid-episode-004/>Deploying multiple Istio ingress gateways</a><li data-nav-id=/community/event/tid-episode-006/ title="Istio Big Talk Episode 4" class=sidelist><a href=/community/event/tid-episode-006/>Istio Big Talk Episode 4</a><li data-nav-id=/community/event/tid-episode-005/ title="Security in Istio" class=sidelist><a href=/community/event/tid-episode-005/>Security in Istio</a><li data-nav-id=/community/event/tid-episode-007/ title="Istio Big Talk Episode 5" class=sidelist><a href=/community/event/tid-episode-007/>Istio Big Talk Episode 5</a><li data-nav-id=/community/event/tid-episode-008/ title="Istio Weekly Episode 6: Envoy Fundamentals" class=sidelist><a href=/community/event/tid-episode-008/>Istio Weekly Episode 6: Envoy Fundamentals</a><li data-nav-id=/community/event/tid-episode-009/ title="Episode 07: Developing Envoy Wasm Extensions" class=sidelist><a href=/community/event/tid-episode-009/>Episode 07: Developing Envoy Wasm Extensions</a><li data-nav-id=/community/event/tid-episode-010/ title="Istio in the enterprise: Solving security and scale challenges for microservices in Kubernetes" class=sidelist><a href=/community/event/tid-episode-010/>Istio in the enterprise: Solving security and scale challenges for microservices in Kubernetes</a><li data-nav-id=/community/event/tid-episode-011/ title="Episode 08: External CA with Istio" class=sidelist><a href=/community/event/tid-episode-011/>Episode 08: External CA with Istio</a><li data-nav-id=/community/event/tid-episode-012/ title="Episode 09: Customizing Istio metrics" class=sidelist><a href=/community/event/tid-episode-012/>Episode 09: Customizing Istio metrics</a><li data-nav-id=/community/event/tid-episode-013/ title class=sidelist><a href=/community/event/tid-episode-013/></a><li data-nav-id=/community/event/tid-episode-016/ title="Access Control for Microservices" class=sidelist><a href=/community/event/tid-episode-016/>Access Control for Microservices</a><li data-nav-id=/community/building-and-testing/ title="Building and Testing" class=sidelist><a href=/community/building-and-testing/>Building and Testing</a><li data-nav-id=/community/contributing/ title="Contributing to GetMesh" class=sidelist><a href=/community/contributing/>Contributing to GetMesh</a><li data-nav-id=/community/event/tid-episode-014/ title="Episode 11: Enterprise service mesh and why you need it" class=sidelist><a href=/community/event/tid-episode-014/>Episode 11: Enterprise service mesh and why you need it</a><li data-nav-id=/community/event/tid-episode-015/ title="Episode 12: How I started contributing to Istio and Envoy" class=sidelist><a href=/community/event/tid-episode-015/>Episode 12: How I started contributing to Istio and Envoy</a><li data-nav-id=/community/event/tid-episode-018/ title="Episode 15: Setting up Istio with external control plane" class=sidelist><a href=/community/event/tid-episode-018/>Episode 15: Setting up Istio with external control plane</a><li data-nav-id=/community/event/tid-episode-017/ title="Istio's new Wasm-based extension mechanism and ecosystem" class=sidelist><a href=/community/event/tid-episode-017/>Istio's new Wasm-based extension mechanism and ecosystem</a></ul></li><li data-nav-id=/fips-request/ title="FIPS Download Request" class=sidelist><a href=/fips-request/>FIPS Download Request</a><ul><li data-nav-id=/fips-request/fips/ title class=sidelist><a href=/fips-request/fips/></a></ul></li></ul></div><div class=col-lg-9><div class="px-lg-5 px-4"><h1 class="mb-4 font-weight-medium">How to use Sticky Sessions</h1><div class=content><h2 id=what-are-sticky-sessions>What are sticky sessions?</h2><p>The idea behind sticky sessions is to route the requests for a particular session to the same endpoint that served the first request. With a sticky session, you can associate a service instance with the caller based on HTTP headers or cookies. You might want to use sticky sessions if your service is doing an expensive operation on the first request but cache the value for all subsequent calls. That way, if the same user makes the request, the costly operation will not be performed, and value from the cache will be used.</p><h2 id=prerequisites>Prerequisites</h2><p>You can follow the <a href=/istio-in-practice/prerequisites>prerequisites</a> for instructions on how to install and setup Istio.</p><h2 id=how-to-use-sticky-sessions-with-istio>How to use sticky sessions with Istio?</h2><p>To demonstrate the functionality of sticky sessions, we will use a sample service called <em>sticky-svc</em>. When called, this service checks for the presence of the <em>x-user</em> header. If the header is present, it tries to look up the header value in the internal cache. On any first request with a new <em>x-user</em>, the value won&rsquo;t exist in the cache, so the service will sleep for 5 seconds (simulating an expensive operation), and after that, it will cache the value. Any subsequent requests with the same <em>x-user</em> header value will return right away. Here&rsquo;s the snippet of this simple logic from the service source code:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#268bd2>var</span> (
  cache = <span style=color:#b58900>make</span>(<span style=color:#268bd2>map</span>[<span style=color:#dc322f>string</span>]<span style=color:#dc322f>bool</span>)
)

<span style=color:#268bd2>func</span> <span style=color:#268bd2>process</span>(userHeaderValue <span style=color:#dc322f>string</span>) {
  <span style=color:#719e07>if</span> cache[userHeaderValue] {
    <span style=color:#719e07>return</span>
  }

  cache[userHeaderValue] = <span style=color:#cb4b16>true</span>
  time.<span style=color:#268bd2>Sleep</span>(<span style=color:#2aa198>5</span> <span style=color:#719e07>*</span> time.Second)
}
</code></pre></div><p>To see the sticky sessions in action, we will need to deploy multiple replicas of this service. That way, when we enable sticky sessions, the requests with the same <em>x-user</em> header value will always be directed to the pod that initially served the request for the same <em>x-user</em> value. The first request we make will still take 5 seconds. However, any subsequent requests will be instantaneous.</p><p>Let&rsquo;s go ahead create the Kubernetes deployment and service first.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: apps/v1
<span style=color:#268bd2>kind</span>: Deployment
<span style=color:#268bd2>metadata</span>:
  <span style=color:#268bd2>name</span>: sticky-svc
  <span style=color:#268bd2>namespace</span>: default
  <span style=color:#268bd2>labels</span>:
    <span style=color:#268bd2>app</span>: sticky-svc
    <span style=color:#268bd2>version</span>: v1
<span style=color:#268bd2>spec</span>:
  <span style=color:#268bd2>replicas</span>: <span style=color:#2aa198>5</span>
  <span style=color:#268bd2>selector</span>:
    <span style=color:#268bd2>matchLabels</span>:
      <span style=color:#268bd2>app</span>: sticky-svc
      <span style=color:#268bd2>version</span>: v1
  <span style=color:#268bd2>template</span>:
    <span style=color:#268bd2>metadata</span>:
      <span style=color:#268bd2>labels</span>:
        <span style=color:#268bd2>app</span>: sticky-svc
        <span style=color:#268bd2>version</span>: v1
    <span style=color:#268bd2>spec</span>:
      <span style=color:#268bd2>containers</span>:
        - <span style=color:#268bd2>image</span>: gcr.io/tetratelabs/sticky-svc:1.0.0
          <span style=color:#268bd2>imagePullPolicy</span>: Always
          <span style=color:#268bd2>name</span>: svc
          <span style=color:#268bd2>ports</span>:
            - <span style=color:#268bd2>containerPort</span>: <span style=color:#2aa198>8080</span>
---
<span style=color:#268bd2>kind</span>: Service
<span style=color:#268bd2>apiVersion</span>: v1
<span style=color:#268bd2>metadata</span>:
  <span style=color:#268bd2>name</span>: sticky-svc
  <span style=color:#268bd2>namespace</span>: default
  <span style=color:#268bd2>labels</span>:
    <span style=color:#268bd2>app</span>: sticky-svc
<span style=color:#268bd2>spec</span>:
  <span style=color:#268bd2>selector</span>:
    <span style=color:#268bd2>app</span>: sticky-svc
  <span style=color:#268bd2>ports</span>:
    - <span style=color:#268bd2>port</span>: <span style=color:#2aa198>8080</span>
      <span style=color:#268bd2>name</span>: http
</code></pre></div><p>Save the above YAML to <code>sticky-deployment.yaml</code> and run <code>kubectl apply -f sticky-deployment.yaml</code> to create the Deployment and Service.</p><p>To access the service from an external IP, we also need a Gateway resource:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: Gateway
<span style=color:#268bd2>metadata</span>:
  <span style=color:#268bd2>name</span>: gateway
<span style=color:#268bd2>spec</span>:
  <span style=color:#268bd2>selector</span>:
    <span style=color:#268bd2>istio</span>: ingressgateway
  <span style=color:#268bd2>servers</span>:
    - <span style=color:#268bd2>port</span>:
        <span style=color:#268bd2>number</span>: <span style=color:#2aa198>80</span>
        <span style=color:#268bd2>name</span>: http
        <span style=color:#268bd2>protocol</span>: HTTP
      <span style=color:#268bd2>hosts</span>:
        - <span style=color:#2aa198>&#39;*&#39;</span>
</code></pre></div><p>Save the above YAML to <code>gateway.yaml</code> and deploy it using <code>kubectl apply -f gateway.yaml</code>.</p><p>Next, we can deploy the VirtualService and attach it to the Gateway.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: VirtualService
<span style=color:#268bd2>metadata</span>:
  <span style=color:#268bd2>name</span>: sticky-svc
  <span style=color:#268bd2>namespace</span>: default
<span style=color:#268bd2>spec</span>:
  <span style=color:#268bd2>hosts</span>:
    - <span style=color:#2aa198>&#39;*&#39;</span>
  <span style=color:#268bd2>gateways</span>:
    - gateway
  <span style=color:#268bd2>http</span>:
    - <span style=color:#268bd2>route</span>:
      - <span style=color:#268bd2>destination</span>:
          <span style=color:#268bd2>host</span>: sticky-svc.default.svc.cluster.local
          <span style=color:#268bd2>port</span>:
            <span style=color:#268bd2>number</span>: <span style=color:#2aa198>8080</span>
</code></pre></div><p>Save the above YAML to <code>sticky-vs.yaml</code> and create it using <code>kubectl apply -f sticky-vs.yaml</code></p><p>Let&rsquo;s make sure everything works fine without configuring sticky sessions by invoking the <code>/ping</code> endpoint a couple of times with the <code>x-user</code> header value set:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ curl -H &#34;x-user: ricky&#34; http://localhost/ping

Call was processed by host sticky-svc-689b4b7876-cv5t9 for user ricky and it took 5.0002721s
</code></pre></div><p>The first request (as expected) will take 5 seconds. If you make a couple of more requests, you will see that some of them will also take 5 seconds, and some of them (being directed to one of the previous pods) will take significantly less, perhaps 500 microseconds.</p><p>With the creation of a sticky session, we want to achieve that all subsequent requests finish within a matter of microseconds, instead of taking 5 seconds. The sticky session settings can be configured in a destination rule for the service.</p><p>At a high level, there are two options to pick the load balancer settings. The first option is called simple, and we can only pick one of the load balancing algorithms shown in the table below.</p><table><thead><tr><th style=text-align:left>Name</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>ROUND_ROBIN</td><td style=text-align:left>Round Robin load balancing algorithm (default)</td></tr><tr><td style=text-align:left>LEAST_CONN</td><td style=text-align:left>This algorithm selects two random healthy hosts and picks the one with fewer active requests</td></tr><tr><td style=text-align:left>RANDOM</td><td style=text-align:left>Randomly selects a host</td></tr><tr><td style=text-align:left>PASSTHROUGH</td><td style=text-align:left>Forwards the connection to the requested IP address without any load balancing</td></tr></tbody></table><p>For example, this snippet would set the load balancing algorithm to <code>LEAST_CONN</code>:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: DestinationRule
<span style=color:#268bd2>metadata</span>:
    <span style=color:#268bd2>name</span>: sticky-svc
    <span style=color:#268bd2>namespace</span>: default
<span style=color:#268bd2>spec</span>:
    <span style=color:#268bd2>host</span>: sticky-service.default.svc.cluster.local
    <span style=color:#268bd2>trafficPolicy</span>:
      <span style=color:#268bd2>loadBalancer</span>:
        <span style=color:#268bd2>simple</span>: LEAST_CONN
</code></pre></div><p>The second option for setting the load balancer settings is using the field called <code>consistentHash</code>. This option allows us to provide session affinity based on the HTTP headers (<code>httpHeaderName</code>), cookies (<code>httpCookie</code>), or other properties (source IP, for example, using <code>useSourceIp: true</code> setting).</p><p>Let&rsquo;s define a consistent hash algorithm in the destination rule using the <em>x-user</em> header name and deploy it:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: DestinationRule
<span style=color:#268bd2>metadata</span>:
    <span style=color:#268bd2>name</span>: sticky-svc
    <span style=color:#268bd2>namespace</span>: default
<span style=color:#268bd2>spec</span>:
    <span style=color:#268bd2>host</span>: sticky-svc.default.svc.cluster.local
    <span style=color:#268bd2>trafficPolicy</span>:
      <span style=color:#268bd2>loadBalancer</span>:
        <span style=color:#268bd2>consistentHash</span>:
          <span style=color:#268bd2>httpHeaderName</span>: x-user
</code></pre></div><p>Save the above YAML to <code>sticky-dr-hash.yaml</code> and deploy it using <code>kubectl apply -f sticky-dr-hash.yaml</code>.</p><p>Before we test it out, let&rsquo;s restart all Pods so we get a clean slate and clear the in-memory cache. First, we scaled down the deployment to 0 replicas, and then we scale it back up to 5 replicas:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl scale deploy sticky-svc --replicas<span style=color:#719e07>=</span><span style=color:#2aa198>0</span>
kubectl scale deploy sticky-svc --replicas<span style=color:#719e07>=</span><span style=color:#2aa198>5</span>
</code></pre></div><p>Once all replicas are running, try and make the first request to the endpoint:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ curl -H &#34;x-user: ricky&#34; http://localhost/ping
Call was processed by host sticky-svc-689b4b7876-cq8hs for user ricky and it took 5.0003232s
</code></pre></div><p>As expected, the first request takes 5 seconds. However, any subsequent requests will go to the same instance and will take considerably less:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>$ curl -H &#34;x-user: ricky&#34; http://localhost/ping
Call was process by host sticky-svc-689b4b7876-cq8hs for user ricky and it took 47.4µs
$ curl -H &#34;x-user: ricky&#34; http://localhost/ping
Call was process by host sticky-svc-689b4b7876-cq8hs for user ricky and it took 53.7µs
$ curl -H &#34;x-user: ricky&#34; http://localhost/ping
Call was process by host sticky-svc-689b4b7876-cq8hs for user ricky and it took 46.1µs
$ curl -H &#34;x-user: ricky&#34; http://localhost/ping
Call was process by host sticky-svc-689b4b7876-cq8hs for user ricky and it took 76.5µs
</code></pre></div><p>This is a sticky session in action! If we send a request with a different user, it will initially take 5 seconds, but then it will go to the same pod again.</p></div><nav class=pagination><a class="nav nav-prev" href=/istio-in-practice/traffic-mirroring/><i class="ti-arrow-left mr-2"></i>
<span class="d-none d-md-block">How to use Traffic Mirroring</span></a>
<a class="nav nav-next" href=/istio-in-practice/setting-up-ssl-certs/><span class="d-none d-md-block">How to set up SSL Certificates</span><i class="ti-arrow-right ml-2"></i></a></nav></div></div></div></div></section><footer><div class=container><div class="row align-items-center pb-0 footer-logo"><a class=navbar-brand href=/><img id=getistio-footer-logo class=img-fluid src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a href=https://www.tetrate.io target=_blank><img id=tetrate-footer-logo class=img-fluid src=/images/tetrate-logo.svg alt="Tetrate Logo"></a></div><div class="py-4 text-center"><div class=mb-4><ul class="list-inline social-icons text-lg-center text-center"><li class=list-inline-item><a href=https://www.tetrate.io/ target=_blank aria-label="Tetrate website"><i class=ti-world></i></a></li><li class=list-inline-item><a href=https://www.twitter.com/tetrateio target=_blank aria-label="Tetrate Twitter account"><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://www.github.com/tetratelabs target=_blank aria-label="Tetrate Github account"><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/tetrate/ target=_blank aria-label="Tetrate LinkedIn account"><i class=ti-linkedin></i></a></li></ul></div><small class=text-white>Support: Join our <a href=https://tetr8.io/tetrate-community target=_blank>#tid-and-getmesh Slack Channel</a> for Community Support</small><br><small class=text-white>License: Tetrate Istio Distro is an open source project and is released under Apache License 2.0 | <a href=https://www.tetrate.io/privacy target=_blank>Privacy Statement</a></small><br><small class=text-white>Official project site of istio is <a href=https://www.istio.io target=_blank>istio.io</a></small><br><small class=text-white>Copyright &copy; 2023 <a href=https://www.tetrate.io target=_blank>Tetrate</a> All rights reserved.</small></div></div></footer><script type=text/javascript>var indexURL="/index.json",baseurl="https://istio.tetratelabs.io/"</script><script src=/plugins/jQuery/jquery.min.js></script><script src=/plugins/bootstrap/bootstrap.min.js></script><script src=/plugins/featherlight/featherlight.min.js></script><script src=/plugins/clipboard/clipboard.min.js></script><script src=/plugins/match-height/jquery.matchHeight-min.js></script><script src=/plugins/search/auto-complete.js></script><script src=/plugins/search/search.js></script><script src=/plugins/search/lunr.min.js></script><script src=/plugins/search/fuse.min.js></script><script src=/plugins/search/mark.js></script><script src=/plugins/search/search-page.js></script><script src=/js/script.min.js></script><script src=/js/form.min.js></script><script type=text/javascript src="//js.hsforms.net/forms/v2.js?pre=1"></script><script async defer src=https://buttons.github.io/buttons.js></script></body></html>