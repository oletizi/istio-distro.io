<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title itemprop=name>如何部署多个 Istio 入口网关 | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品</title><meta name=twitter:title content="如何部署多个 Istio 入口网关 | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta itemprop=name content="如何部署多个 Istio 入口网关 | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta name=application-name content="如何部署多个 Istio 入口网关 | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta property="og:site_name" content="Tetrate Istio Distro"><meta name=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta itemprop=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta name=twitter:description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:locale" content="zh"><meta name=language content="中文"><link rel=alternate hreflang=en href=/istio-in-practice/multiple-ingress-gateways/><link rel=alternate hreflang=zh href=/zh/istio-in-practice/multiple-ingress-gateways/><meta property="og:updated_time" content="2021-01-01T11:02:05+0600"><link rel=sitemap type=application/xml title=Sitemap href=/sitemap.xml><link href=/zh/istio-in-practice/multiple-ingress-gateways/index.xml rel=alternate type=application/rss+xml title="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"><link href=/zh/istio-in-practice/multiple-ingress-gateways/index.xml rel=feed type=application/rss+xml title="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"><meta property="og:type" content="website"><meta name=author content="Tetrate"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","url":"https:\/\/istio.tetratelabs.io\/zh\/istio-in-practice\/multiple-ingress-gateways\/","sameAs":["","https:\/\/github.com\/tetratelabs\/getmesh"],"name":"Tetrate Istio Distro | Simple, safe enterprise-grade Istio","logo":"https://getistio.io/images/getistio-by-tetrate-logo.png"}</script><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@tetrateio"><meta name=twitter:creator content="@tetrateio"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-P3J9XNBME4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-P3J9XNBME4')</script><link rel=preload href=/plugins/themify-icons/themify-icons.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css></noscript><link rel=preload href=/plugins/search/auto-complete.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/search/auto-complete.css></noscript><link rel=preload href=/plugins/featherlight/featherlight.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/featherlight/featherlight.min.css></noscript><link rel=preload href=/css/bootstrap/bootstrap.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css></noscript><link rel=preload href=/scss/style.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/scss/style.css></noscript><link rel="shortcut icon" href=/images/getistio-favicon.png type=image/x-icon><link rel=icon href=/images/getistio-favicon.png type=image/x-icon><meta property="og:title" content="如何部署多个 Istio 入口网关"><meta property="og:description" content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:type" content="website"><meta property="og:url" content="https://istio.tetratelabs.io/zh/istio-in-practice/multiple-ingress-gateways/"><meta property="og:image" content="https://istio.tetratelabs.io/images/twitter-card-new.png"><script async defer src=/js/turbolinks.min.js></script></head><body><header class="sticky-top navigation"><div class=my-container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><div class=navbar-brand-container><a class=navbar-brand href=/zh><img class="img-fluid logo-width" src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a class=github-button href=https://github.com/tetratelabs/getistio data-icon=octicon-star aria-label="Star tetratelabs/getmesh on GitHub">Star</a></div><button aria-label=Menu class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h4 text-white"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto align-items-center"><li class=nav-item><a class=nav-link href=/zh/getmesh-cli/>文档</a></li><li class=nav-item><a class=nav-link href=/zh/blog/>博客</a></li><li class=nav-item><a class=nav-link href=/zh/community-events/>社区</a></li><li class=nav-item><a class=nav-link href=https://academy.tetrate.io target=_blank>培训</a></li><li class=nav-item><a class=nav-link href=https://func-e.io/ target=_blank>func-e</a></li><li class=nav-item><a class=nav-link href=https://www.istio.io/ target=_blank>Istio.io</a></li><li class=nav-link><select class=nav-item id=select-language onchange="location=this.value"><option id=en value=/istio-in-practice/multiple-ingress-gateways/>En</option><option id=zh value=/zh/istio-in-practice/multiple-ingress-gateways/ selected>中文</option></select></li></ul><div class="d-lg-none d-block"><a href=/zh/download class="btn btn-sm btn-primary ml-lg-4">download</a></div></div><div class="d-lg-flex d-none"><a href=/zh/download class="btn btn-sm btn-primary ml-lg-4">下载</a></div></nav></div></header><section class=pt-5><div class="container d-block d-sm-block d-lg-none"><div class="row justify-content-center mb-4"><div><button onclick=dropdownFunction() class="btn btn-primary dropdown-toggle nav-dropdown">Browse Docs
<span class=caret></span></button><ul id=mobileDropdownMenu class=dropdown-content><li data-nav-id=/zh/getmesh-cli/ title="GetMesh 概览" class="sidelist my-2"><a href=/zh/getmesh-cli/>GetMesh 概览</a></li><li data-nav-id=/zh/config-validation/ title=配置验证 class="sidelist my-2"><a href=/zh/config-validation/>配置验证</a></li><li data-nav-id=/zh/istio-ca-certs-integrations/ title="Istio CA Certs 集成" class="sidelist my-2"><a href=/zh/istio-ca-certs-integrations/>Istio CA Certs 集成</a></li><li data-nav-id=/zh/istio-in-practice/ title="Istio 实践教程" class="sidelist parent my-2"><a href=/zh/istio-in-practice/>Istio 实践教程</a></li><li data-nav-id=/zh/ecosystem-partners/ title="生态 & 合作伙伴" class="sidelist my-2"><a href=/zh/ecosystem-partners/>生态 & 合作伙伴</a></li><li data-nav-id=/zh/istio-cheatsheet/ title="Istio 速查表" class="sidelist my-2"><a href=/zh/istio-cheatsheet/>Istio 速查表</a></li><li data-nav-id=/zh/faq/ title=FAQ class="sidelist my-2"><a href=/zh/faq/>FAQ</a></li><li data-nav-id=/zh/community/ title=社区 class="sidelist my-2"><a href=/zh/community/>社区</a></li><li data-nav-id=/zh/download/ title=下载 class="sidelist my-2"><a href=/zh/download/>下载</a></li></ul></div></div></div><div class="container shadow section-sm rounded docs-content"><div class=row><div class="col-lg-3 d-none d-md-none d-lg-block"><ul class=sidenav><li data-nav-id=/zh/getmesh-cli/ title="GetMesh 概览" class=sidelist><a href=/zh/getmesh-cli/>GetMesh 概览</a><ul><li data-nav-id=/zh/getmesh-cli/install-istio/ title="安装 Istio" class=sidelist><a href=/zh/getmesh-cli/install-istio/>安装 Istio</a><li data-nav-id=/zh/getmesh-cli/install-istio-updates/ title="安装 Istio 更新" class=sidelist><a href=/zh/getmesh-cli/install-istio-updates/>安装 Istio 更新</a><li data-nav-id=/zh/getmesh-cli/install-and-update-of-getistio/ title="安装和更新 GetMesh" class=sidelist><a href=/zh/getmesh-cli/install-and-update-of-getistio/>安装和更新 GetMesh</a><li data-nav-id=/zh/getmesh-cli/install-istio-and-manage-multiple-istioctl/ title="管理多个 istioctl" class=sidelist><a href=/zh/getmesh-cli/install-istio-and-manage-multiple-istioctl/>管理多个 istioctl</a><li data-nav-id=/zh/getmesh-cli/reference/ title=参考 class=sidelist><a href=/zh/getmesh-cli/reference/>参考</a><ul><li data-nav-id=/zh/getmesh-cli/reference/getmesh/ title=getmesh class=sidelist><a href=/zh/getmesh-cli/reference/getmesh/>getmesh</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_check-upgrade/ title="getmesh check-upgrade" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_check-upgrade/>getmesh check-upgrade</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_config-validate/ title="getmesh config-validate" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_config-validate/>getmesh config-validate</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_default-hub/ title="getmesh default-hub" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_default-hub/>getmesh default-hub</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_fetch/ title="getmesh fetch" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_fetch/>getmesh fetch</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_gen-ca/ title="getmesh gen-ca" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_gen-ca/>getmesh gen-ca</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_help/ title="getmesh help" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_help/>getmesh help</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_istioctl/ title="getmesh istioctl" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_istioctl/>getmesh istioctl</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_list/ title="getmesh list" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_list/>getmesh list</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_prune/ title="getmesh prune" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_prune/>getmesh prune</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_show/ title="getmesh show" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_show/>getmesh show</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_switch/ title="getmesh switch" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_switch/>getmesh switch</a><li data-nav-id=/zh/getmesh-cli/reference/getmesh_version/ title="getmesh version" class=sidelist><a href=/zh/getmesh-cli/reference/getmesh_version/>getmesh version</a></ul></li></ul></li><li data-nav-id=/zh/config-validation/ title=配置验证 class=sidelist><a href=/zh/config-validation/>配置验证</a><ul><li data-nav-id=/zh/config-validation/istio-config-validation/ title=配置验证详情 class=sidelist><a href=/zh/config-validation/istio-config-validation/>配置验证详情</a></ul></li><li data-nav-id=/zh/istio-ca-certs-integrations/ title="Istio CA Certs 集成" class=sidelist><a href=/zh/istio-ca-certs-integrations/>Istio CA Certs 集成</a><ul><li data-nav-id=/zh/istio-ca-certs-integrations/acmpca-integration/ title="ACM Private CA 集成" class=sidelist><a href=/zh/istio-ca-certs-integrations/acmpca-integration/>ACM Private CA 集成</a><li data-nav-id=/zh/istio-ca-certs-integrations/gcp-cas-integration/ title="GCP CAS 集成" class=sidelist><a href=/zh/istio-ca-certs-integrations/gcp-cas-integration/>GCP CAS 集成</a><li data-nav-id=/zh/istio-ca-certs-integrations/cert-manager-integration/ title="cert-manager CA 集成" class=sidelist><a href=/zh/istio-ca-certs-integrations/cert-manager-integration/>cert-manager CA 集成</a></ul></li><li data-nav-id=/zh/istio-in-practice/ title="Istio 实践教程" class="sidelist parent"><a href=/zh/istio-in-practice/>Istio 实践教程</a><ul><li data-nav-id=/zh/istio-in-practice/prerequisites/ title=先决条件 class=sidelist><a href=/zh/istio-in-practice/prerequisites/>先决条件</a><li data-nav-id=/zh/istio-in-practice/zero-downtime-releases/ title=如何执行零停机时间发布 class=sidelist><a href=/zh/istio-in-practice/zero-downtime-releases/>如何执行零停机时间发布</a><li data-nav-id=/zh/istio-in-practice/traffic-mirroring/ title=如何使用流量镜像 class=sidelist><a href=/zh/istio-in-practice/traffic-mirroring/>如何使用流量镜像</a><li data-nav-id=/zh/istio-in-practice/sticky-sessions/ title=如何使用粘性会话 class=sidelist><a href=/zh/istio-in-practice/sticky-sessions/>如何使用粘性会话</a><li data-nav-id=/zh/istio-in-practice/setting-up-ssl-certs/ title="如何设置 SSL 证书" class=sidelist><a href=/zh/istio-in-practice/setting-up-ssl-certs/>如何设置 SSL 证书</a><li data-nav-id=/zh/istio-in-practice/multiple-ingress-gateways/ title="如何部署多个 Istio 入口网关" class="sidelist parent active"><a href=/zh/istio-in-practice/multiple-ingress-gateways/>如何部署多个 Istio 入口网关</a><li data-nav-id=/zh/istio-in-practice/aws-cloudmap-integration/ title="将 AWS Cloud Map 与 Istio 集成" class=sidelist><a href=/zh/istio-in-practice/aws-cloudmap-integration/>将 AWS Cloud Map 与 Istio 集成</a><li data-nav-id=/zh/istio-in-practice/install-skywalking/ title="集成 Apache SkyWalking" class=sidelist><a href=/zh/istio-in-practice/install-skywalking/>集成 Apache SkyWalking</a></ul></li><li data-nav-id=/zh/ecosystem-partners/ title="生态 & 合作伙伴" class=sidelist><a href=/zh/ecosystem-partners/>生态 & 合作伙伴</a><ul><li data-nav-id=/zh/ecosystem-partners/appviewx/ title=AppViewX class=sidelist><a href=/zh/ecosystem-partners/appviewx/>AppViewX</a><li data-nav-id=/zh/ecosystem-partners/jetstack/ title=Jetstack class=sidelist><a href=/zh/ecosystem-partners/jetstack/>Jetstack</a><ul><li data-nav-id=/zh/ecosystem-partners/jetstack/cert-manager/ title="Cert Manager" class=sidelist><a href=/zh/ecosystem-partners/jetstack/cert-manager/>Cert Manager</a></ul></li><li data-nav-id=/zh/ecosystem-partners/keyfactor/ title=Keyfactor class=sidelist><a href=/zh/ecosystem-partners/keyfactor/>Keyfactor</a><li data-nav-id=/zh/ecosystem-partners/weaveworks/ title=Weaveworks class=sidelist><a href=/zh/ecosystem-partners/weaveworks/>Weaveworks</a></ul></li><li data-nav-id=/zh/istio-cheatsheet/ title="Istio 速查表" class=sidelist><a href=/zh/istio-cheatsheet/>Istio 速查表</a><ul><li data-nav-id=/zh/istio-cheatsheet/cheatsheet/ title class=sidelist><a href=/zh/istio-cheatsheet/cheatsheet/></a></ul></li><li data-nav-id=/zh/faq/ title=FAQ class=sidelist><a href=/zh/faq/>FAQ</a><ul><li data-nav-id=/zh/faq/faqs/ title class=sidelist><a href=/zh/faq/faqs/></a></ul></li><li data-nav-id=/zh/community/ title=社区 class=sidelist><a href=/zh/community/>社区</a><ul><li data-nav-id=/zh/community/event/ title=活动 class=sidelist><a href=/zh/community/event/>活动</a><ul><li data-nav-id=/zh/community/event/getistio-inaugural/ title="00: GetIstio 介绍——社区开幕 meetup" class=sidelist><a href=/zh/community/event/getistio-inaugural/>00: GetIstio 介绍——社区开幕 meetup</a><li data-nav-id=/zh/community/event/istiocon-2021/ title="IstioCon 2021" class=sidelist><a href=/zh/community/event/istiocon-2021/>IstioCon 2021</a><li data-nav-id=/zh/community/event/getenvoy-deep-dive/ title="01：使用 GetEnvoy 轻松实现 Envoy 和 WASM" class=sidelist><a href=/zh/community/event/getenvoy-deep-dive/>01：使用 GetEnvoy 轻松实现 Envoy 和 WASM</a><li data-nav-id=/zh/community/event/getistio-deep-dive/ title="02：使用 GetIstio 轻松管理 Istio" class=sidelist><a href=/zh/community/event/getistio-deep-dive/>02：使用 GetIstio 轻松管理 Istio</a><li data-nav-id=/zh/community/event/istio-big-talk-ep-01/ title="《Istio 大咖说》第 1 期：Istio 开源四周年回顾与展望" class=sidelist><a href=/zh/community/event/istio-big-talk-ep-01/>《Istio 大咖说》第 1 期：Istio 开源四周年回顾与展望</a><li data-nav-id=/zh/community/event/istio-big-talk-ep-02/ title="《Istio 大咖说》第 2 期：从微服务架构到 Istio——架构升级实践分享" class=sidelist><a href=/zh/community/event/istio-big-talk-ep-02/>《Istio 大咖说》第 2 期：从微服务架构到 Istio——架构升级实践分享</a><li data-nav-id=/zh/community/event/istio-big-talk-ep-03/ title="《Istio 大咖说》第 3 期：如何让 Istio 变得更为高效和智能" class=sidelist><a href=/zh/community/event/istio-big-talk-ep-03/>《Istio 大咖说》第 3 期：如何让 Istio 变得更为高效和智能</a><li data-nav-id=/zh/community/event/istio-big-talk-ep-04/ title="《Istio 大咖说》第 4 期：如何让 Istio 在大规模生产中落地" class=sidelist><a href=/zh/community/event/istio-big-talk-ep-04/>《Istio 大咖说》第 4 期：如何让 Istio 在大规模生产中落地</a><li data-nav-id=/zh/community/event/istio-big-talk-ep-05/ title="《Istio 大咖说》第 5 期：腾讯云服务网格生产落地最佳实践" class=sidelist><a href=/zh/community/event/istio-big-talk-ep-05/>《Istio 大咖说》第 5 期：腾讯云服务网格生产落地最佳实践</a><li data-nav-id=/zh/community/event/istio-big-talk-ep-06/ title="《Istio 大咖说》第 6 期：Envoy Proxy 在线答疑" class=sidelist><a href=/zh/community/event/istio-big-talk-ep-06/>《Istio 大咖说》第 6 期：Envoy Proxy 在线答疑</a><li data-nav-id=/zh/community/event/istio-big-talk-ep-07/ title="《Istio 大咖说》第 7 期：基于 Envoy/Istio 的云原生 API 网关 —— 开源项目 Hango 的设计与实现" class=sidelist><a href=/zh/community/event/istio-big-talk-ep-07/>《Istio 大咖说》第 7 期：基于 Envoy/Istio 的云原生 API 网关 —— 开源项目 Hango 的设计与实现</a></ul></li><li data-nav-id=/community/building-and-testing/ title="Building and Testing" class=sidelist><a href=/community/building-and-testing/>Building and Testing</a><li data-nav-id=/community/contributing/ title="Contributing to GetMesh" class=sidelist><a href=/community/contributing/>Contributing to GetMesh</a><li data-nav-id=/community/release/ title="Release process" class=sidelist><a href=/community/release/>Release process</a></ul></li><li data-nav-id=/zh/download/ title=下载 class=sidelist><a href=/zh/download/>下载</a><ul><li data-nav-id=/zh/download/downloads/ title class=sidelist><a href=/zh/download/downloads/></a></ul></li></ul></div><div class=col-lg-9><div class="px-lg-5 px-4"><h1 class="mb-4 font-weight-medium">如何部署多个 Istio 入口网关</h1><div class=content><p>安装 Istio 时，可以选择要使用的安装配置文件。最新的 Istio 版本中有六个安装配置文件：default、demo、minimal、remote、empty 和 preview。</p><p>每个配置文件包含不同的组件组合。例如，如果您选择最小配置文件，则只会安装<code>istiod</code>。不会安装出口或入口网关。另一方面，如果使用演示配置文件，则 Istio 会同时安装入口和出口网关<code>istiod</code>。</p><p>您可以在<a href=https://istio.io/latest/docs/setup/additional-setup/config-profiles/>Istio 的 docs 页面</a>上阅读有关配置配置文件的更多信息，并检查属于配置文件的组件。</p><p>使用 <a href=/>Tetrate Istio Distro</a> 您可以传入安装配置文件名称来安装 Istio。例如，要安装演示配置文件，可以运行以下命令：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh istioctl install --set <span style=color:#268bd2>profile</span><span style=color:#719e07>=</span>demo
</code></pre></div><p>您还可以通过将其他<code>--set &lt;key>=&lt;value></code>键 / 值对传递给命令来自定义 Istio 安装，而不考虑配置文件 。</p><h2 id=为什么要使用多个网关>为什么要使用多个网关？</h2><p>现在，在您创建多个入口网关（以及您的云提供商使用多个负载均衡器）之前，请确保您需要它。负载平衡器需要花钱，这是您需要管理的另一件事。单个负载均衡器可以在很多情况下很好地工作，但是在某些情况下，您可能有一个私有或内部负载均衡器，而又有一个公共负载均衡器。</p><p>具有单个负载均衡器的方案如下图所示。</p><p><img src=single-load-balancer.png alt="Single Load Balancer"></p><p>在这种情况下，我们有两个不同的外部 IP，它们指向在同一 Kubernetes 集群中运行的两个不同的入口网关。让我们看看如何实现这一目标。</p><h2 id=配置网关>配置网关</h2><p>首先，我们需要查看单个 Ingress 网关的 Istio 配置，当您使用默认网关（或演示 / 预览配置文件）时将对其进行部署。我们可以使用以下<code>profile dump</code>命令获取配置：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh istioctl profile dump --config-path components.ingressGateways &gt; ingress-gateway.yaml
</code></pre></div><blockquote><p>如果您看到一条消息，说<code>proto: tag has too few fields: "-"</code>您可以放心地忽略它。这是当前正在解决的<a href=https://github.com/istio/istio/issues/26751>已知问题</a>。</p></blockquote><p><code>ingress-gateway.yaml</code>文件内容如下所示：</p><p><img src=two-load-balancers.png alt="Two Load Balancers"></p><p>在这种情况下，我们有两个不同的外部 IP，它们指向在同一 Kubernetes 集群中运行的两个不同的入口网关。让我们看看如何实现这一目标。</p><h2 id=配置网关-1>配置网关</h2><p>首先，我们需要查看单个 Ingress 网关的 Istio 配置，当您使用默认网关（或演示 / 预览配置文件）时将对其进行部署。我们可以使用以下<code>profile dump</code>命令获取配置：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh istioctl profile dump --config-path components.ingressGateways &gt; ingress-gateway.yaml
</code></pre></div><blockquote><p>如果您看到一条消息，说<code>proto: tag has too few fields: "-"</code>您可以放心地忽略它。这是当前正在解决的<a href=https://github.com/istio/istio/issues/26751>已知问题</a>。</p></blockquote><p><code>ingress-gateway.yaml</code>文件内容如下所示：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#268bd2>enabled</span>: <span style=color:#cb4b16>true</span>
  <span style=color:#268bd2>k8s</span>:
    <span style=color:#268bd2>env</span>:
    - <span style=color:#268bd2>name</span>: ISTIO_META_ROUTER_MODE
      <span style=color:#268bd2>value</span>: standard
    <span style=color:#268bd2>hpaSpec</span>:
      <span style=color:#268bd2>maxReplicas</span>: <span style=color:#2aa198>5</span>
      <span style=color:#268bd2>metrics</span>:
      - <span style=color:#268bd2>resource</span>:
          <span style=color:#268bd2>name</span>: cpu
          <span style=color:#268bd2>targetAverageUtilization</span>: <span style=color:#2aa198>80</span>
        <span style=color:#268bd2>type</span>: Resource
      <span style=color:#268bd2>minReplicas</span>: <span style=color:#2aa198>1</span>
      <span style=color:#268bd2>scaleTargetRef</span>:
        <span style=color:#268bd2>apiVersion</span>: apps/v1
        <span style=color:#268bd2>kind</span>: Deployment
        <span style=color:#268bd2>name</span>: istio-ingressgateway
    <span style=color:#268bd2>resources</span>:
      <span style=color:#268bd2>limits</span>:
        <span style=color:#268bd2>cpu</span>: 2000m
        <span style=color:#268bd2>memory</span>: 1024Mi
      <span style=color:#268bd2>requests</span>:
        <span style=color:#268bd2>cpu</span>: 100m
        <span style=color:#268bd2>memory</span>: 128Mi
    <span style=color:#268bd2>service</span>:
      <span style=color:#268bd2>ports</span>:
      - <span style=color:#268bd2>name</span>: status-port
        <span style=color:#268bd2>port</span>: <span style=color:#2aa198>15021</span>
        <span style=color:#268bd2>protocol</span>: TCP
        <span style=color:#268bd2>targetPort</span>: <span style=color:#2aa198>15021</span>
      - <span style=color:#268bd2>name</span>: http2
        <span style=color:#268bd2>port</span>: <span style=color:#2aa198>80</span>
        <span style=color:#268bd2>protocol</span>: TCP
        <span style=color:#268bd2>targetPort</span>: <span style=color:#2aa198>8080</span>
      - <span style=color:#268bd2>name</span>: https
        <span style=color:#268bd2>port</span>: <span style=color:#2aa198>443</span>
        <span style=color:#268bd2>protocol</span>: TCP
        <span style=color:#268bd2>targetPort</span>: <span style=color:#2aa198>8443</span>
      - <span style=color:#268bd2>name</span>: tcp-istiod
        <span style=color:#268bd2>port</span>: <span style=color:#2aa198>15012</span>
        <span style=color:#268bd2>protocol</span>: TCP
        <span style=color:#268bd2>targetPort</span>: <span style=color:#2aa198>15012</span>
      - <span style=color:#268bd2>name</span>: tls
        <span style=color:#268bd2>port</span>: <span style=color:#2aa198>15443</span>
        <span style=color:#268bd2>protocol</span>: TCP
        <span style=color:#268bd2>targetPort</span>: <span style=color:#2aa198>15443</span>
    <span style=color:#268bd2>strategy</span>:
      <span style=color:#268bd2>rollingUpdate</span>:
        <span style=color:#268bd2>maxSurge</span>: <span style=color:#2aa198>100</span>%
        <span style=color:#268bd2>maxUnavailable</span>: <span style=color:#2aa198>25</span>%
  <span style=color:#268bd2>name</span>: istio-ingressgateway
</code></pre></div><p>上面定义的设置用于默认的 Istio 入口网关。YAML 包括 HorizontalPodAutoscaler 配置（<code>hpaSpec</code>），资源限制和请求（<code>resources</code>），服务端口（<code>ports</code>），部署策略（<code>strategy</code>）和环境变量（<code>env</code>）。</p><p>安装 Istio 时，我们可以直接在 IstioOperator 资源中定义一个或多个网关。这是一个部署单个（默认）入口网关的 Istio 运算符的示例：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: install.istio.io/v1alpha1
<span style=color:#268bd2>kind</span>: IstioOperator
<span style=color:#268bd2>spec</span>:
  <span style=color:#268bd2>components</span>:
    <span style=color:#268bd2>ingressGateways</span>:
      - <span style=color:#268bd2>name</span>: istio-ingressgateway
        <span style=color:#268bd2>enabled</span>: <span style=color:#cb4b16>true</span>
</code></pre></div><p>要部署第二个入口网关，我们可以在<code>ingressGateways</code>field 下添加一个条目。例如，让我们添加第二个<code>istio-ingressgateway-staging</code>在命名空间中调用的网关<code>staging</code>：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: install.istio.io/v1alpha1
<span style=color:#268bd2>kind</span>: IstioOperator
<span style=color:#268bd2>spec</span>:
  <span style=color:#268bd2>components</span>:
    <span style=color:#268bd2>ingressGateways</span>:
      - <span style=color:#268bd2>name</span>: istio-ingressgateway
        <span style=color:#268bd2>enabled</span>: <span style=color:#cb4b16>true</span>
      - <span style=color:#268bd2>name</span>: istio-ingressgateway-staging
        <span style=color:#268bd2>namespace</span>: staging
        <span style=color:#268bd2>enabled</span>: <span style=color:#cb4b16>true</span>
</code></pre></div><p>在进行部署之前，我们还需要修改此新网关将使用的标签。请记住，如果我们不指定任何内容，则 Istio 将使用默认的网关配置，并且最终将得到两个带有相同标签的网关，尽管它们位于不同的命名空间中。</p><p>IstioOperator 允许我们仅通过设置<code>label</code>字段来添加新标签或修改现有标签。更新后的 IstioOperator 如下所示：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: install.istio.io/v1alpha1
<span style=color:#268bd2>kind</span>: IstioOperator
<span style=color:#268bd2>spec</span>:
  <span style=color:#268bd2>components</span>:
    <span style=color:#268bd2>ingressGateways</span>:
      - <span style=color:#268bd2>name</span>: istio-ingressgateway
        <span style=color:#268bd2>enabled</span>: <span style=color:#cb4b16>true</span>
      - <span style=color:#268bd2>name</span>: istio-ingressgateway-staging
        <span style=color:#268bd2>namespace</span>: staging
        <span style=color:#268bd2>enabled</span>: <span style=color:#cb4b16>true</span>
        <span style=color:#268bd2>label</span>:
            <span style=color:#268bd2>istio</span>: istio-ingressgateway-staging
</code></pre></div><p>此 YAML 确保将标签<code>istio: istio-ingressgateway-staging</code>应用于 Istio 为入口网关创建的所有资源。在安装运算符之前，我们需要先创建<code>staging</code>名称空间：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl create ns staging
</code></pre></div><p>现在我们准备安装 Istio。将上述 YAML 保存到<code>istio-2-gw.yaml</code>并用于<code>getmesh</code>安装：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ getmesh istioctl install -f istio-2-gw.yaml
This will install the Istio default profile with <span style=color:#719e07>[</span><span style=color:#2aa198>&#34;Istio core&#34;</span> <span style=color:#2aa198>&#34;Istiod&#34;</span> <span style=color:#2aa198>&#34;Ingress gateways&#34;</span><span style=color:#719e07>]</span> components into the cluster. Proceed? <span style=color:#719e07>(</span>y/N<span style=color:#719e07>)</span> y
✔ Istio core installed
✔ Istiod installed
✔ Ingress gateways installed
✔ Installation <span style=color:#b58900>complete</span>
</code></pre></div><p>安装完成后，可以在<code>staging</code>名称空间中列出 Pod 和 Services ：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ kubectl get po,svc -n staging
NAME                                               READY   STATUS    RESTARTS   AGE
pod/istio-ingressgateway-staging-8b59464d7-fvlhx   1/1     Running   <span style=color:#2aa198>0</span>          5m30s

NAME                                   TYPE           CLUSTER-IP     EXTERNAL-IP     PORT<span style=color:#719e07>(</span>S<span style=color:#719e07>)</span>                                                      AGE
service/istio-ingressgateway-staging   LoadBalancer   10.96.13.200   XX.XXX.XXX.XX   15021:31259/TCP,80:31104/TCP,443:31853/TCP,15443:31053/TCP   5m29s
</code></pre></div><p>您会注意到正在运行的<code>istio-ingressgateway-staging</code>Pod 和<code>istio-ingressgateway-staging</code>类型为 LoadBalancer 的服务，其外部 IP 与在<code>istio-system</code>名称空间中运行的默认入口网关不同。</p><h3 id=测试多个-istio-网关>测试多个 Istio 网关</h3><p>是时候测试网关了！确保使用标记了<code>default</code>名称空间<code>istio-injection=enabled</code>（请参阅<a href=http://localhost:1313/istio-in-practice/multiple-ingress-gateways/prerequisites>先决条件</a>），然后使用下面的代码片段创建服务，部署，网关和 VirtualService。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cat <span style=color:#2aa198>&lt;&lt; EOF | kubectl apply -f -
</span><span style=color:#2aa198>apiVersion: v1
</span><span style=color:#2aa198>kind: Service
</span><span style=color:#2aa198>metadata:
</span><span style=color:#2aa198>  name: nginx
</span><span style=color:#2aa198>  namespace: default
</span><span style=color:#2aa198>  labels:
</span><span style=color:#2aa198>    app: nginx
</span><span style=color:#2aa198>spec:
</span><span style=color:#2aa198>  ports:
</span><span style=color:#2aa198>  - port: 80
</span><span style=color:#2aa198>    name: http
</span><span style=color:#2aa198>  selector:
</span><span style=color:#2aa198>    app: nginx
</span><span style=color:#2aa198>---
</span><span style=color:#2aa198>apiVersion: apps/v1
</span><span style=color:#2aa198>kind: Deployment
</span><span style=color:#2aa198>metadata:
</span><span style=color:#2aa198>  name: nginx
</span><span style=color:#2aa198>  namespace: default
</span><span style=color:#2aa198>  labels:
</span><span style=color:#2aa198>    app: nginx
</span><span style=color:#2aa198>spec:
</span><span style=color:#2aa198>  replicas: 1
</span><span style=color:#2aa198>  selector:
</span><span style=color:#2aa198>    matchLabels:
</span><span style=color:#2aa198>      app: nginx
</span><span style=color:#2aa198>  template:
</span><span style=color:#2aa198>    metadata:
</span><span style=color:#2aa198>      labels:
</span><span style=color:#2aa198>        app: nginx
</span><span style=color:#2aa198>    spec:
</span><span style=color:#2aa198>      containers:
</span><span style=color:#2aa198>      - name: nginx
</span><span style=color:#2aa198>        image: nginx:alpine
</span><span style=color:#2aa198>        imagePullPolicy: IfNotPresent
</span><span style=color:#2aa198>        ports:
</span><span style=color:#2aa198>        - containerPort: 80
</span><span style=color:#2aa198>---
</span><span style=color:#2aa198>apiVersion: networking.istio.io/v1alpha3
</span><span style=color:#2aa198>kind: Gateway
</span><span style=color:#2aa198>metadata:
</span><span style=color:#2aa198>  name: gateway
</span><span style=color:#2aa198>  namespace: default
</span><span style=color:#2aa198>spec:
</span><span style=color:#2aa198>  selector:
</span><span style=color:#2aa198>    istio: ingressgateway
</span><span style=color:#2aa198>  servers:
</span><span style=color:#2aa198>  - port:
</span><span style=color:#2aa198>      number: 80
</span><span style=color:#2aa198>      name: http
</span><span style=color:#2aa198>      protocol: HTTP
</span><span style=color:#2aa198>    hosts:
</span><span style=color:#2aa198>    - &#39;*&#39;
</span><span style=color:#2aa198>---
</span><span style=color:#2aa198>apiVersion: networking.istio.io/v1alpha3
</span><span style=color:#2aa198>kind: VirtualService
</span><span style=color:#2aa198>metadata:
</span><span style=color:#2aa198>  name: nginx-1
</span><span style=color:#2aa198>  namespace: default
</span><span style=color:#2aa198>spec:
</span><span style=color:#2aa198>  hosts:
</span><span style=color:#2aa198>  - &#34;*&#34;
</span><span style=color:#2aa198>  gateways:
</span><span style=color:#2aa198>  - gateway
</span><span style=color:#2aa198>  http:
</span><span style=color:#2aa198>  - route:
</span><span style=color:#2aa198>    - destination:
</span><span style=color:#2aa198>        host: nginx
</span><span style=color:#2aa198>        port:
</span><span style=color:#2aa198>          number: 80
</span><span style=color:#2aa198>EOF</span>
</code></pre></div><p>等待 Pod 启动，然后在浏览器中打开第一个入口网关 IP 地址。您可以使用以下命令获取 IP 地址：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl get svc istio-ingressgateway -n istio-system  -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span>
</code></pre></div><p>您应该恢复默认的 “欢迎使用 nginx！” 页。让我们看看如果尝试打开部署的第二个入口网关的外部 IP 会发生什么。您可以使用上述类似的命令通过更新服务名称和名称空间来获取 IP 地址：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl get svc istio-ingressgateway-staging -n staging  -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span>
</code></pre></div><p>您将无法连接到登台入口网关，这是预期的。我们尚未部署任何可配置入口的网关资源。让我们将标签值更新为<code>istio-ingressgateway-staging</code>并重新部署网关资源：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cat <span style=color:#2aa198>&lt;&lt;EOF | kubectl apply -f -
</span><span style=color:#2aa198>apiVersion: networking.istio.io/v1alpha3
</span><span style=color:#2aa198>kind: Gateway
</span><span style=color:#2aa198>metadata:
</span><span style=color:#2aa198>  name: gateway
</span><span style=color:#2aa198>  namespace: default
</span><span style=color:#2aa198>spec:
</span><span style=color:#2aa198>  selector:
</span><span style=color:#2aa198>    istio: istio-ingressgateway-staging
</span><span style=color:#2aa198>  servers:
</span><span style=color:#2aa198>  - port:
</span><span style=color:#2aa198>      number: 80
</span><span style=color:#2aa198>      name: http
</span><span style=color:#2aa198>      protocol: HTTP
</span><span style=color:#2aa198>    hosts:
</span><span style=color:#2aa198>    - &#39;*&#39;
</span><span style=color:#2aa198>EOF</span>
</code></pre></div><p>这次，您应该通过登台网关访问 Nginx 主页，而原始网关不会指向任何内容。</p><p>此时，您可以创建一个单独的网关资源来独立控制两个入口网关。</p></div><nav class=pagination><a class="nav nav-prev" href=/zh/istio-in-practice/setting-up-ssl-certs/><i class="ti-arrow-left mr-2"></i>
<span class="d-none d-md-block">如何设置 SSL 证书</span></a>
<a class="nav nav-next" href=/zh/istio-in-practice/aws-cloudmap-integration/><span class="d-none d-md-block">将 AWS Cloud Map 与 Istio 集成</span><i class="ti-arrow-right ml-2"></i></a></nav></div></div></div></div></section><footer><div class=container><div class="row align-items-center pb-0 footer-logo"><a class=navbar-brand href=/zh><img id=getistio-footer-logo class=img-fluid src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a href=https://www.tetrate.io target=_blank><img id=tetrate-footer-logo class=img-fluid src=/images/tetrate-logo.svg alt="Tetrate Logo"></a></div><div class="py-4 text-center"><div class=mb-4><ul class="list-inline social-icons text-lg-center text-center"><li class=list-inline-item><a href=https://www.tetrate.io/ target=_blank aria-label="Tetrate website"><i class=ti-world></i></a></li><li class=list-inline-item><a href=https://www.twitter.com/tetrateio target=_blank aria-label="Tetrate Twitter account"><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://www.github.com/tetratelabs target=_blank aria-label="Tetrate Github account"><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/tetrate/ target=_blank aria-label="Tetrate LinkedIn account"><i class=ti-linkedin></i></a></li></ul></div><small class=text-white>Support: Join our <a href=https://tetr8.io/tetrate-community target=_blank>#tid-and-getmesh Slack Channel</a> for Community Support</small><br><small class=text-white>License: Tetrate Istio Distro is an open source project and is released under Apache License 2.0 | <a href=https://www.tetrate.io/privacy target=_blank>Privacy Statement</a></small><br><small class=text-white>Official project site of istio is <a href=https://www.istio.io target=_blank>istio.io</a></small><br><small class=text-white>Copyright &copy; 2023 <a href=https://www.tetrate.io target=_blank>Tetrate</a> All rights reserved.</small></div></div></footer><script type=text/javascript>var indexURL="/index.json",baseurl="https://istio.tetratelabs.io//zh"</script><script src=/plugins/jQuery/jquery.min.js></script><script src=/plugins/bootstrap/bootstrap.min.js></script><script src=/plugins/featherlight/featherlight.min.js></script><script src=/plugins/clipboard/clipboard.min.js></script><script src=/plugins/match-height/jquery.matchHeight-min.js></script><script src=/plugins/search/auto-complete.js></script><script src=/plugins/search/search.js></script><script src=/plugins/search/lunr.min.js></script><script src=/plugins/search/fuse.min.js></script><script src=/plugins/search/mark.js></script><script src=/plugins/search/search-page.js></script><script src=/js/script.min.js></script><script src=/js/form.min.js></script><script type=text/javascript src="//js.hsforms.net/forms/v2.js?pre=1"></script><script async defer src=https://buttons.github.io/buttons.js></script></body></html>