<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title itemprop=name>如何使用 Tetrate Istio Distro 在 GKE 上安装 Istio | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品</title><meta name=twitter:title content="如何使用 Tetrate Istio Distro 在 GKE 上安装 Istio | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta itemprop=name content="如何使用 Tetrate Istio Distro 在 GKE 上安装 Istio | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta name=application-name content="如何使用 Tetrate Istio Distro 在 GKE 上安装 Istio | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta property="og:site_name" content="Tetrate Istio Distro"><meta name=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta itemprop=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta name=twitter:description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:locale" content="zh"><meta name=language content="中文"><link rel=alternate hreflang=en href=/blog/how-to-set-up-istio-with-getistio-on-gke/><link rel=alternate hreflang=zh href=/zh/blog/how-to-set-up-istio-with-getistio-on-gke/><meta property="og:updated_time" content="2020-02-07T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=/sitemap.xml><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="2020-02-07T00:00:00Z"><meta property="article:published_time" content="2020-02-07T00:00:00Z"><meta property="og:article:author" content="[宋净超](Https jimmysong.io)"><meta property="article:author" content="[宋净超](Https jimmysong.io)"><meta name=author content="[宋净超](Https jimmysong.io)"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"如何使用 Tetrate Istio Distro 在 GKE 上安装 Istio","author":{"@type":"Person","name":"https:\/\/github.com\/tetratelabs\/getmesh"},"datePublished":"2020-02-07","description":"本文将带大家亲身体验Tetrate Istio Distro在GKE上的安装和使用。","wordCount":1677,"mainEntityOfPage":"True","dateModified":"2020-02-07","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Tetrate Istio Distro | Simple, safe enterprise-grade Istio","logo":{"@type":"imageObject","url":"https://getistio.io/images/getistio-by-tetrate-logo.png"}}}</script><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@tetrateio"><meta name=twitter:creator content="@tetrateio"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-P3J9XNBME4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-P3J9XNBME4')</script><link rel=preload href=/plugins/themify-icons/themify-icons.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css></noscript><link rel=preload href=/plugins/search/auto-complete.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/search/auto-complete.css></noscript><link rel=preload href=/plugins/featherlight/featherlight.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/featherlight/featherlight.min.css></noscript><link rel=preload href=/css/bootstrap/bootstrap.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css></noscript><link rel=preload href=/scss/style.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/scss/style.css></noscript><link rel="shortcut icon" href=/images/getistio-favicon.png type=image/x-icon><link rel=icon href=/images/getistio-favicon.png type=image/x-icon><meta property="og:title" content="如何使用 Tetrate Istio Distro 在 GKE 上安装 Istio"><meta property="og:description" content="本文将带大家亲身体验Tetrate Istio Distro在GKE上的安装和使用。"><meta property="og:type" content="article"><meta property="og:url" content="https://istio.tetratelabs.io/zh/blog/how-to-set-up-istio-with-getistio-on-gke/"><meta property="og:image" content="https://istio.tetratelabs.io/images/twitter-card-new.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-02-07T00:00:00+00:00"><meta property="article:modified_time" content="2020-02-07T00:00:00+00:00"><script async defer src=/js/turbolinks.min.js></script></head><body><header class="sticky-top navigation"><div class=my-container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><div class=navbar-brand-container><a class=navbar-brand href=/zh><img class="img-fluid logo-width" src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a class=github-button href=https://github.com/tetratelabs/getistio data-icon=octicon-star aria-label="Star tetratelabs/getmesh on GitHub">Star</a></div><button aria-label=Menu class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h4 text-white"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto align-items-center"><li class=nav-item><a class=nav-link href=/zh/getmesh-cli/>文档</a></li><li class=nav-item><a class=nav-link href=/zh/blog/>博客</a></li><li class=nav-item><a class=nav-link href=/zh/community-events/>社区</a></li><li class=nav-item><a class=nav-link href=https://academy.tetrate.io target=_blank>培训</a></li><li class=nav-item><a class=nav-link href=https://func-e.io/ target=_blank>func-e</a></li><li class=nav-item><a class=nav-link href=https://www.istio.io/ target=_blank>Istio.io</a></li><li class=nav-link><select class=nav-item id=select-language onchange="location=this.value"><option id=en value=/blog/how-to-set-up-istio-with-getistio-on-gke/>En</option><option id=zh value=/zh/blog/how-to-set-up-istio-with-getistio-on-gke/ selected>中文</option></select></li></ul><div class="d-lg-none d-block"><a href=/zh/download class="btn btn-sm btn-primary ml-lg-4">download</a></div></div><div class="d-lg-flex d-none"><a href=/zh/download class="btn btn-sm btn-primary ml-lg-4">下载</a></div></nav></div></header><section class="py-5 blog-individual"><div class=container><div class="row mt-0 mb-0 justify-content-center"><div class=col-12><a href=../ class=link-grey>← 返回博客列表</a><hr></div><div class="col-sm-9 mt-3"><h1>如何使用 Tetrate Istio Distro 在 GKE 上安装 Istio</h1><p class="blog-date mt-3"><span class=author-info>作者 <a href=https://jimmysong.io>宋净超</a></span>
<span>发布于 2020年2月7日</span>
/ 8 分钟阅读</p><div class="article-tags mb-4"></div></div></div><div class="row justify-content-center mt-0 blog-content"><div class=col-sm-9><p>Tetrate Istio Distro 是由 Tetrate 开源的基于 Istio 的发行版。他主要解决了用户使用 Istio 时候的以下痛点：</p><ul><li>Istio 生命周期管理</li><li>经过测试的安全的 Istio 配置</li><li>可原生的计算环境支持</li><li>陡峭的学习曲线及持续支持</li></ul><p>想要了解更多关于 Tetrate Istio Distro 的信息请访问 <a href=https://istio.tetratelabs.io/>https://istio.tetratelabs.io/</a>。</p><p>本文将从带你动手安装和使用 Istio，包括：</p><ul><li>在 GKE 上安装 Istio 1.7</li><li>添加一台虚拟机到 mesh 中</li><li>部署 Bookinfo 示例</li><li>集成虚拟机测试</li><li>升级 Istio 到 1.8</li></ul><p>从以上过程中你将了解 Istio 的部署架构、基本功能和操作。</p><h2 id=准备条件>准备条件</h2><p>为了完成动手操作，你需要准备以下环境：</p><ul><li>一个 Google Cloud 账号，并且其中有足够的余额</li><li>在本地安装 <code>gcloud</code> 工具安装 Istio</li></ul><p>这篇博客只适用于 Istio 1.7，1.8 版本的虚拟机整合步骤有变化，请参考 <a href=https://istio.io/latest/docs/setup/install/virtual-machine/>Istio 文档</a>。</p><h2 id=安装-istio>安装 Istio</h2><p>使用 Tetrate Istio Distro 安装 Istio 1.7.5。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>curl -sL https://istio.tetratelabs.io/getmesh/install.sh | bash
getmesh fetch 1.7.5
</code></pre></div><p>使用 <a href=https://istio.io/latest/docs/setup/getting-started/>demo profile</a>（包括 Ingress gateway、egress gateway 和 Istiod 所有组件） 安装 Istio：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>getmesh istioctl install --set profile=demo --set values.global.meshExpansion.enabled=true
Detected that your cluster does not support third party JWT authentication. Falling back to less secure first party JWT. See https://istio.io/docs/ops/best-practices/security/#configure-third-party-service-account-tokens for details.
✔ Istio core installed
✔ Istiod installed
✔ Ingress gateways installed
✔ Egress gateways installed
✔ Installation complete
</code></pre></div><p>查看 <code>istio-system</code> namespace 下的 pod：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>kubectl get pod -n=istio-system
NAME                                   READY   STATUS   RESTARTS   AGE
istio-egressgateway-695f5944d8-wdk6s    1/1     Running   0         67s
istio-ingressgateway-5c697d4cd7-4cgq7   1/1     Running   0         67s
istiod-59747cbfdd-sbffx                 1/1     Running   0         106s
</code></pre></div><p>设置 sidecar 自动注入：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl label namespace bookinfo istio-injection<span style=color:#719e07>=</span>enabled
</code></pre></div><p>部署 <a href=https://istio.io/latest/docs/examples/bookinfo/>Bookinfo</a> 示例。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>kubectl create ns bookinfo
kubectl apply -n bookinfo -f samples/bookinfo/platform/kube/bookinfo.yaml
service/details created
serviceaccount/bookinfo-details created
deployment.apps/details-v1 created
service/ratings created
serviceaccount/bookinfo-ratings created
deployment.apps/ratings-v1 created
service/reviews created
serviceaccount/bookinfo-reviews created
deployment.apps/reviews-v1 created
deployment.apps/reviews-v2 created
deployment.apps/reviews-v3 created
service/productpage created
serviceaccount/bookinfo-productpage created
deployment.apps/productpage-v1 created
</code></pre></div><p>确认示例部署完成。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl <span style=color:#b58900>exec</span> <span style=color:#2aa198>&#34;</span><span style=color:#719e07>$(</span>kubectl get pod -n bookinfo -l <span style=color:#268bd2>app</span><span style=color:#719e07>=</span>ratings -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#719e07>)</span><span style=color:#2aa198>&#34;</span> -n bookinfo -c ratings -- curl -s productpage:9080/productpage | grep -o <span style=color:#2aa198>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</code></pre></div><p>正常情况下你将看到这样的显示：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>&lt;title&gt;Simple Bookstore App&lt;/title&gt;
</code></pre></div><p>允许外网访问 mesh：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl -n bookinfo apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
<span style=color:#b58900>export</span> <span style=color:#268bd2>INGRESS_PORT</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].nodePort}&#39;</span><span style=color:#719e07>)</span>
<span style=color:#b58900>export</span> <span style=color:#268bd2>SECURE_INGRESS_PORT</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.spec.ports[?(@.name==&#34;https&#34;)].nodePort}&#39;</span><span style=color:#719e07>)</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$INGRESS_PORT</span><span style=color:#2aa198>&#34;</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$SECURE_INGRESS_PORT</span><span style=color:#2aa198>&#34;</span>
<span style=color:#b58900>export</span> <span style=color:#268bd2>INGRESS_HOST</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#719e07>)</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$INGRESS_HOST</span><span style=color:#2aa198>&#34;</span>
<span style=color:#b58900>export</span> <span style=color:#268bd2>GATEWAY_URL</span><span style=color:#719e07>=</span><span style=color:#268bd2>$INGRESS_HOST</span>:<span style=color:#268bd2>$INGRESS_PORT</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$GATEWAY_URL</span><span style=color:#2aa198>&#34;</span>
</code></pre></div><p>应用默认的 DestinationRule。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl apply -n bookinfo -f samples/bookinfo/networking/destination-rule-all.yaml
</code></pre></div><h2 id=向-istio-mesh-中加入虚拟机>向 Istio mesh 中加入虚拟机</h2><p>我们将在虚拟机中安装 MySQL，并将其配置为 ratings 服务的后台。最终，<a href=https://istio.io/latest/docs/examples/bookinfo/>bookinfo</a> 示例的拓扑将如下图所示。</p><p><img src=008eGmZEly1gngfmhrx7aj316k0u079c.jpg alt="引入虚拟机的 Bookinfo 示例"></p><p>我们将在 Google cloud 中创建一台虚拟机，并将它添加到 Istio Mesh 中。假设虚拟机实例的名称是 <code>instance-1</code>，首先为虚拟机创建证书。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl create secret generic cacerts -n istio-system <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    --from-file<span style=color:#719e07>=</span>samples/certs/ca-cert.pem <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    --from-file<span style=color:#719e07>=</span>samples/certs/ca-key.pem <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    --from-file<span style=color:#719e07>=</span>samples/certs/root-cert.pem <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    --from-file<span style=color:#719e07>=</span>samples/certs/cert-chain.pem
</code></pre></div><p>安装 Istio mesh 扩展。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh istioctl install <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    -f manifests/examples/vm/values-istio-meshexpansion.yaml
</code></pre></div><p>在 Cloud shell 中执行以下命令，生成虚拟机扩展的配置文件。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#268bd2>VM_NAME</span><span style=color:#719e07>=</span>instance-1
<span style=color:#268bd2>VM_NAMESPACE</span><span style=color:#719e07>=</span>vm
<span style=color:#268bd2>WORK_DIR</span><span style=color:#719e07>=</span>vm
<span style=color:#268bd2>SERVICE_ACCOUNT</span><span style=color:#719e07>=</span>instance-1
cat <span style=color:#2aa198>&lt;&lt;EOF&gt; &#34;${WORK_DIR}&#34;/vmintegration.yaml
</span><span style=color:#2aa198>apiVersion: install.istio.io/v1alpha1
</span><span style=color:#2aa198>kind: IstioOperator
</span><span style=color:#2aa198>spec:
</span><span style=color:#2aa198> values:
</span><span style=color:#2aa198>   global:
</span><span style=color:#2aa198>     meshExpansion:
</span><span style=color:#2aa198>       enabled: true
</span><span style=color:#2aa198>EOF</span>
getmesh istioctl install -f <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/vmintegration.yaml
kubectl create namespace <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>VM_NAMESPACE</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
kubectl create serviceaccount <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>SERVICE_ACCOUNT</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span> -n <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>VM_NAMESPACE</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
 <span style=color:#586e75># 1 hours，注意这个过期时间，这个 token 仅在认证时候使用，后面就不需要了。</span>
<span style=color:#268bd2>tokenexpiretime</span><span style=color:#719e07>=</span><span style=color:#2aa198>3600</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;{&#34;kind&#34;:&#34;TokenRequest&#34;,&#34;apiVersion&#34;:&#34;authentication.k8s.io/v1&#34;,&#34;spec&#34;:{&#34;audiences&#34;:[&#34;istio-ca&#34;],&#34;expirationSeconds&#34;:&#39;</span><span style=color:#268bd2>$tokenexpiretime</span><span style=color:#2aa198>&#39;}}&#39;</span> | kubectl create --raw /api/v1/namespaces/<span style=color:#268bd2>$VM_NAMESPACE</span>/serviceaccounts/<span style=color:#268bd2>$SERVICE_ACCOUNT</span>/token -f - | jq -j <span style=color:#2aa198>&#39;.status.token&#39;</span> &gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/istio-token
kubectl -n <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>VM_NAMESPACE</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span> get configmaps istio-ca-root-cert -o json | jq -j <span style=color:#2aa198>&#39;.&#34;data&#34;.&#34;root-cert.pem&#34;&#39;</span> &gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/root-cert
<span style=color:#268bd2>ISTIO_SERVICE_CIDR</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span><span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Service&#34;,&#34;metadata&#34;:{&#34;name&#34;:&#34;tst&#34;},&#34;spec&#34;:{&#34;clusterIP&#34;:&#34;1.1.1.1&#34;,&#34;ports&#34;:[{&#34;port&#34;:443}]}}&#39;</span> | kubectl apply -f - 2&gt;&amp;<span style=color:#2aa198>1</span> | sed <span style=color:#2aa198>&#39;s/.*valid IPs is //&#39;</span><span style=color:#719e07>)</span>
touch <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/cluster.env
<span style=color:#b58900>echo</span> <span style=color:#268bd2>ISTIO_SERVICE_CIDR</span><span style=color:#719e07>=</span><span style=color:#268bd2>$ISTIO_SERVICE_CIDR</span> &gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/cluster.env
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;ISTIO_INBOUND_PORTS=3306,8080&#34;</span> &gt;&gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/cluster.env
touch <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/hosts-addendum
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>INGRESS_HOST</span><span style=color:#2aa198>}</span><span style=color:#2aa198> istiod.istio-system.svc&#34;</span> &gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/hosts-addendum
touch <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/sidecar.env
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;PROV_CERT=/var/run/secrets/istio&#34;</span> &gt;&gt;<span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/sidecar.env
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;OUTPUT_CERTS=/var/run/secrets/istio&#34;</span> &gt;&gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/sidecar.env
</code></pre></div><p>将虚拟机配置文件导入到虚拟机实例 <code>instance-1</code> 中。使用 ssh 登录到虚拟机实例 <code>instance-1</code> 中，将为 Kubernetes 集群和 Istio 生成的文件拷贝到虚拟机的 <code>$HOME</code> 目录下。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo apt -y update
sudo apt -y upgrade
sudo mkdir -p /var/run/secrets/istio
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/root-cert.pem /var/run/secrets/istio/root-cert.pem
sudo  mkdir -p /var/run/secrets/tokens
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/istio-token /var/run/secrets/tokens/istio-token
<span style=color:#586e75># Setup Istio on the VM</span>
curl -LO https://storage.googleapis.com/istio-release/releases/1.7.1/deb/istio-sidecar.deb
sudo dpkg -i istio-sidecar.deb
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/cluster.env /var/lib/istio/envoy/cluster.env
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/sidecar.env /var/lib/istio/envoy/sidecar.env
sudo sh -c <span style=color:#2aa198>&#39;cat $(eval echo ~$SUDO_USER)/hosts-addendum &gt;&gt; /etc/hosts&#39;</span>
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/root-cert.pem /var/run/secrets/istio/root-cert.pem
sudo mkdir -p /etc/istio/proxy
sudo chown -R istio-proxy /var/lib/istio /etc/certs /etc/istio/proxy /var/run/secrets
</code></pre></div><p>注意：默认情况下虚拟机的防火墙会拒绝对 3306 端口的入站请求，我们需要配置 VPC 中的防火墙规则，以允许 mesh 中的服务访问虚拟机的 3306 端口。</p><p>现在可以启动虚拟机中的 Istio 了。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo systemctl start istio
</code></pre></div><h2 id=虚拟机集成测试>虚拟机集成测试</h2><p>在虚拟机中安装 MySQL，并作为服务的后端。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo apt-get update <span style=color:#719e07>&amp;&amp;</span> sudo apt-get install -y mariadb-server
sudo mysql
GRANT ALL PRIVILEGES ON *.* TO <span style=color:#2aa198>&#39;root&#39;</span>@<span style=color:#2aa198>&#39;localhost&#39;</span> IDENTIFIED BY <span style=color:#2aa198>&#39;password&#39;</span> WITH GRANT OPTION;
quit;
sudo systemctl restart mysql
curl -q https://raw.githubusercontent.com/istio/istio/release-1.7/samples/bookinfo/src/mysql/mysqldb-init.sql | mysql -u root -ppassword
mysql -u root -ppassword <span style=color:#b58900>test</span> -e <span style=color:#2aa198>&#34;select * from ratings;&#34;</span>
mysql -u root -ppassword <span style=color:#b58900>test</span> -e  <span style=color:#2aa198>&#34;update ratings set rating=5 where reviewid=1;select * from ratings;&#34;</span>
hostname -I
<span style=color:#586e75># 假如这里获取到的 IP 地址是 &lt;virtual_machine_ip&gt;</span>
</code></pre></div><p>将虚拟机中的服务注册到 mesh 中。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh istioctl experimental add-to-mesh -n vm mysqldb &lt;virtual_machine_ip&gt; mysql:3306
</code></pre></div><p>将看到这样的输出：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>2020-09-17T11:34:37.740252Z     warn   Got &#39;services &#34;mysqldb&#34; not found&#39; looking up svc &#39;mysqldb&#39; in namespace &#39;vm&#39;, attempting to create it
2020-09-17T11:34:38.111244Z     warn   Got &#39;endpoints &#34;mysqldb&#34; not found&#39; looking up endpoints for &#39;mysqldb&#39; in namespace &#39;vm&#39;, attempting to create them
</code></pre></div><p>部署 ratings 服务的 v2 版本，使用 MySQL 作为存储后端。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl apply -n bookinfo -f samples/bookinfo/platform/kube/bookinfo-ratings-v2-mysql-vm.yaml
kubectl apply -n bookinfo -f samples/bookinfo/networking/virtual-service-ratings-mysql-vm.yaml
</code></pre></div><p>为部署在虚拟机上的 MySQL 服务添加 DestinationRule、ServiceEntry 和 WorkloadEntry 的配置。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: DestinationRule
<span style=color:#268bd2>metadata</span>:
 <span style=color:#268bd2>name</span>: mtls-mysqldb-vm
<span style=color:#268bd2>spec</span>:
 <span style=color:#268bd2>host</span>: mysqldb.vm.svc.cluster.local
 <span style=color:#268bd2>trafficPolicy</span>:
   <span style=color:#268bd2>tls</span>:
     <span style=color:#268bd2>mode</span>: ISTIO_MUTUAL
---
<span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: ServiceEntry
<span style=color:#268bd2>metadata</span>:
 <span style=color:#268bd2>name</span>: mysqldb-vm
<span style=color:#268bd2>spec</span>:
 <span style=color:#268bd2>hosts</span>:
 - mysqldb.vm.svc.cluster.local
 <span style=color:#268bd2>location</span>: MESH_INTERNAL
 <span style=color:#268bd2>ports</span>:
 - <span style=color:#268bd2>number</span>: <span style=color:#2aa198>3306</span>
   <span style=color:#268bd2>name</span>: mysql
   <span style=color:#268bd2>protocol</span>: mysql
 <span style=color:#268bd2>resolution</span>: STATIC
 <span style=color:#268bd2>workloadSelector</span>:
   <span style=color:#268bd2>labels</span>:
     <span style=color:#268bd2>app</span>: mysqldb-vm
---
<span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: WorkloadEntry
<span style=color:#268bd2>metadata</span>:
 <span style=color:#268bd2>name</span>: mysqldb-vm
<span style=color:#268bd2>spec</span>:
 <span style=color:#268bd2>address</span>: &lt;virtual_machine_ip&gt; <span style=color:#586e75>#修改为虚拟机的 IP</span>
 <span style=color:#268bd2>labels</span>:
   <span style=color:#268bd2>app</span>: mysqldb-vm
   <span style=color:#268bd2>instance-id</span>: ubuntu-vm-mariadb
</code></pre></div><h2 id=升级到-isito-18>升级到 Isito 1.8</h2><p>2020 年 11 月 19 日，Istio 1.8 发布，支持使用<a href=https://istio.io/latest/docs/setup/upgrade/in-place/> canary</a> 和<a href=https://istio.io/latest/docs/setup/upgrade/in-place/> in-place</a> 升级。下面我们将使用 in-place 方式升级 Istio。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh fetch --version 1.8
getmesh istioctl upgrade
Confirm to proceed <span style=color:#719e07>[</span>y/N<span style=color:#719e07>]</span>?
</code></pre></div><p>输入 y 确认升级，确认控制平面升级完成后，接下来我们来升级数据平面。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl rollout restart deployment --namespace bookinfo
</code></pre></div><p>使用 <code>getmesh istioctl proxy-status -n bookinfo</code> 命令检查 proxy 的版本，可以看到都已经升级为了 1.8.0。</p><h2 id=常用命令>常用命令</h2><p>以下是在以上操作过程中的常用命令。</p><p><strong>使用 gcloud 命令登录到 Google cloud 的虚拟机</strong></p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>gcloud compute ssh jimmy@instance-1 --zone<span style=color:#719e07>=</span>us-west2-a
</code></pre></div><p><strong>清理 bookinfo 示例</strong></p><p>在解压后的 istio 安装包的根目录下执行：</p><pre><code class=language-wsh data-lang=wsh>samples/bookinfo/platform/kube/cleanup.sh
</code></pre></div></div><div class="col-12 blog-post-footer"><hr><a href=/blog/ class=link-grey>← 返回博客列表</a></div></div></section><footer><div class=container><div class="row align-items-center pb-0 footer-logo"><a class=navbar-brand href=/zh><img id=getistio-footer-logo class=img-fluid src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a href=https://www.tetrate.io target=_blank><img id=tetrate-footer-logo class=img-fluid src=/images/tetrate-logo.svg alt="Tetrate Logo"></a></div><div class="py-4 text-center"><div class=mb-4><ul class="list-inline social-icons text-lg-center text-center"><li class=list-inline-item><a href=https://www.tetrate.io/ target=_blank aria-label="Tetrate website"><i class=ti-world></i></a></li><li class=list-inline-item><a href=https://www.twitter.com/tetrateio target=_blank aria-label="Tetrate Twitter account"><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://www.github.com/tetratelabs target=_blank aria-label="Tetrate Github account"><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/tetrate/ target=_blank aria-label="Tetrate LinkedIn account"><i class=ti-linkedin></i></a></li></ul></div><small class=text-white>Support: Join our <a href=https://tetr8.io/tetrate-community target=_blank>#tid-and-getmesh Slack Channel</a> for Community Support</small><br><small class=text-white>License: Tetrate Istio Distro is an open source project and is released under Apache License 2.0 | <a href=https://www.tetrate.io/privacy target=_blank>Privacy Statement</a></small><br><small class=text-white>Official project site of istio is <a href=https://www.istio.io target=_blank>istio.io</a></small><br><small class=text-white>Copyright &copy; 2023 <a href=https://www.tetrate.io target=_blank>Tetrate</a> All rights reserved.</small></div></div></footer><script type=text/javascript>var indexURL="/index.json",baseurl="https://istio.tetratelabs.io//zh"</script><script src=/plugins/jQuery/jquery.min.js></script><script src=/plugins/bootstrap/bootstrap.min.js></script><script src=/plugins/featherlight/featherlight.min.js></script><script src=/plugins/clipboard/clipboard.min.js></script><script src=/plugins/match-height/jquery.matchHeight-min.js></script><script src=/plugins/search/auto-complete.js></script><script src=/plugins/search/search.js></script><script src=/plugins/search/lunr.min.js></script><script src=/plugins/search/fuse.min.js></script><script src=/plugins/search/mark.js></script><script src=/plugins/search/search-page.js></script><script src=/js/script.min.js></script><script src=/js/form.min.js></script><script type=text/javascript src="//js.hsforms.net/forms/v2.js?pre=1"></script><script async defer src=https://buttons.github.io/buttons.js></script></body></html>