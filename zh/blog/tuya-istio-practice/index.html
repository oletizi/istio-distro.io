<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title itemprop=name>涂鸦智能的 Istio 企业级生产环境的实践 | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品</title><meta name=twitter:title content="涂鸦智能的 Istio 企业级生产环境的实践 | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta itemprop=name content="涂鸦智能的 Istio 企业级生产环境的实践 | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta name=application-name content="涂鸦智能的 Istio 企业级生产环境的实践 | 简单、安全的企业级 Istio 发行版 | GetIstio 由 Tetrate 出品"><meta property="og:site_name" content="Tetrate Istio Distro"><meta name=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta itemprop=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta name=twitter:description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:locale" content="zh"><meta name=language content="中文"><link rel=alternate hreflang=en href=/blog/tuya-istio-practice/><link rel=alternate hreflang=zh href=/zh/blog/tuya-istio-practice/><meta property="og:updated_time" content="2021-04-07T10:03:00+0800"><link rel=sitemap type=application/xml title=Sitemap href=/sitemap.xml><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="2021-04-07T10:03:00+0800"><meta property="article:published_time" content="2021-04-07T10:03:00+0800"><meta property="og:article:author" content="涂鸦智能前端团队"><meta property="article:author" content="涂鸦智能前端团队"><meta name=author content="涂鸦智能前端团队"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"涂鸦智能的 Istio 企业级生产环境的实践","author":{"@type":"Person","name":"https:\/\/github.com\/tetratelabs\/getmesh"},"datePublished":"2021-04-07","description":"涂鸦智能前端团队的 Istio 实践。","wordCount":1639,"mainEntityOfPage":"True","dateModified":"2021-04-07","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Tetrate Istio Distro | Simple, safe enterprise-grade Istio","logo":{"@type":"imageObject","url":"https://getistio.io/images/getistio-by-tetrate-logo.png"}}}</script><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@tetrateio"><meta name=twitter:creator content="@tetrateio"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-P3J9XNBME4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-P3J9XNBME4')</script><link rel=preload href=/plugins/themify-icons/themify-icons.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css></noscript><link rel=preload href=/plugins/search/auto-complete.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/search/auto-complete.css></noscript><link rel=preload href=/plugins/featherlight/featherlight.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/featherlight/featherlight.min.css></noscript><link rel=preload href=/css/bootstrap/bootstrap.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css></noscript><link rel=preload href=/scss/style.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/scss/style.css></noscript><link rel="shortcut icon" href=/images/getistio-favicon.png type=image/x-icon><link rel=icon href=/images/getistio-favicon.png type=image/x-icon><meta property="og:title" content="涂鸦智能的 Istio 企业级生产环境的实践"><meta property="og:description" content="涂鸦智能前端团队的 Istio 实践。"><meta property="og:type" content="article"><meta property="og:url" content="https://istio.tetratelabs.io/zh/blog/tuya-istio-practice/"><meta property="og:image" content="https://istio.tetratelabs.io/images/twitter-card-new.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-04-07T10:03:00+08:00"><meta property="article:modified_time" content="2021-04-07T10:03:00+08:00"><script async defer src=/js/turbolinks.min.js></script></head><body><header class="sticky-top navigation"><div class=my-container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><div class=navbar-brand-container><a class=navbar-brand href=/zh><img class="img-fluid logo-width" src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a class=github-button href=https://github.com/tetratelabs/getistio data-icon=octicon-star aria-label="Star tetratelabs/getmesh on GitHub">Star</a></div><button aria-label=Menu class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h4 text-white"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto align-items-center"><li class=nav-item><a class=nav-link href=/zh/getmesh-cli/>文档</a></li><li class=nav-item><a class=nav-link href=/zh/blog/>博客</a></li><li class=nav-item><a class=nav-link href=/zh/community-events/>社区</a></li><li class=nav-item><a class=nav-link href=https://academy.tetrate.io target=_blank>培训</a></li><li class=nav-item><a class=nav-link href=https://func-e.io/ target=_blank>func-e</a></li><li class=nav-item><a class=nav-link href=https://www.istio.io/ target=_blank>Istio.io</a></li><li class=nav-link><select class=nav-item id=select-language onchange="location=this.value"><option id=en value=/blog/tuya-istio-practice/>En</option><option id=zh value=/zh/blog/tuya-istio-practice/ selected>中文</option></select></li></ul><div class="d-lg-none d-block"><a href=/zh/download class="btn btn-sm btn-primary ml-lg-4">download</a></div></div><div class="d-lg-flex d-none"><a href=/zh/download class="btn btn-sm btn-primary ml-lg-4">下载</a></div></nav></div></header><section class="py-5 blog-individual"><div class=container><div class="row mt-0 mb-0 justify-content-center"><div class=col-12><a href=../ class=link-grey>← 返回博客列表</a><hr></div><div class="col-sm-9 mt-3"><h1>涂鸦智能的 Istio 企业级生产环境的实践</h1><p class="blog-date mt-3"><span class=author-info>作者 涂鸦智能前端团队</span>
<span>发布于 2021年4月7日</span>
/ 7 分钟阅读</p><div class="article-tags mb-4"><span class="mr-3 single-tag"><a href=https://istio.tetratelabs.io/zh/tags/istio/>Istio</a></span></div></div></div><div class="row justify-content-center mt-0 blog-content"><div class=col-sm-9><h2 id=背景>背景</h2><p>Istio 作为当前最活跃的 service mesh 项目，提供着众多的能力，流量管理，安全性，可观察性，每一项能力都是服务治理，运维所必需的。Istio 丰富的能力同时也带来一定性的复杂系统运维的挑战，但是相对于能力以及未来的扩展性，Istio 能力给服务治理带来了无限的想象，机遇同时充满着挑战。</p><p>当前涂鸦智能前端业务 Istio 控制面版本为 1.5.0，接入 Istio 控制面 700 + 服务，1100+pod 实例，承担涂鸦智能前端最大的业务集群的流量管控和能力支撑。</p><h2 id=涂鸦智能在开发流程上存在的问题>涂鸦智能在开发流程上存在的问题</h2><p>前端基础团队 2018 年开始接触 Kubernetes，并基于 kubernetes 自建了发布平台服务于前端业务团队，但随着业务团队越来越大，开发发布流程上开始出现一些问题：</p><ol><li>多分支并行开发的验证问题</li><li>多地域环境带来的配置复杂性导致的线上问题</li></ol><p>最开始考虑让业务团队自己内部调整处理，但由于出现问题的团队越来越多，我们开始考虑通过灰度发布能力来解决这些开发发布流程上的问题，在日常预发环境，多个分支发布多个灰度版本，根据不同的 header 分发流量到不同版本，保证每个 feature 分支有单独的实例进行验证，相互之间互不影响。在线上环境提供灰度能力给测试回归，作为项目质量的最后一道防线。</p><p>我们调研了多个方案，也参考内部其他团队的灰度方案，基于实现复杂性和能力的丰富度考量，在 2020 年初，我们开始在生产环境部署了 Istio。虽然 Istio 的接入在一定程度上提高了系统的复杂性，但是它确实给我们带来了惊喜。</p><h2 id=引入-istio-解决的问题>引入 Istio 解决的问题</h2><h3 id=灰度发布>灰度发布</h3><p>基于 Istio 原生自带的资源 <code>VirtualService</code> 和 <code>DestinationRule</code> 构建了发布平台的灰度发布能力。</p><ol><li>发布平台发布的每个应用都打上两个 label <code>canarytag</code> 和 <code>stage</code>，<code>stage</code> 用于标识正常发布和灰度发布，<code>canarytag</code> 用来标识不同的灰度版本</li><li>每发布一个灰度版本，我们就会创建一个对应的灰度 ReplicaSet 实例</li><li>发布对应的 <code>DestinationRule</code> 配置通过 label <code>canarytag</code>，<code>stage</code> 把正常发布和不同版本灰度的实例定义为不同实例集合</li><li>通过 <code>VirtualService</code> 根据不同的 header 分发的不同实例集合</li></ol><p>下图展示的是配置信息。</p><p><img src=canary.png alt></p><h3 id=流量观测和异常感知>流量观测和异常感知</h3><p>我们基于社区原生的 prometheus-operator 搭建了我们的监控平台，每个集群都会单独部署一个 prometheus-operator，并根据采集的对象，划分为业务、Kubernetes 集群基础设施、Istio 数据面流量三个范围，并部署相应的业务 prometheus 实例：Kubernetes 集群基础设施监控 prometheus 实例和 Istio 流量监控 prometheus 实例。</p><p><img src=monitoring.jpg alt></p><p>并通过 Grafana 搭建了整体的数据面流量监控大盘，实现了对流量的观测。</p><p><img src=flow_market.png alt></p><p>并基于当前的监控数据，配置了对应的告警规则，对流量的异常和波动有手段去感知和发现，并及时处理。</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini>sum(envoy_cluster_upstream_cx_active{namespace!<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;fe-pre&#34;}) by (namespace, service) &lt; 1  无可用服务告警</span>
sum by(namespace, service) (rate(envoy_cluster_upstream_rq_503[1m])) &gt; 0    503异常告警
sum by(namespace, service) (rate(envoy_cluster_upstream_rq{response_code_class!<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;2xx&#34;}[1m])) != 0  业务异常告警</span>
</code></pre></div><h2 id=现阶段的成果以及存在问题>现阶段的成果以及存在问题</h2><p>当前线上最大的业务集群所有 pod 实例都已经接入至 Istio 控制面，由 Istio 把控整体的流量，具备流量观测能力。</p><p><img src=flow.png alt></p><p>灰度发布数占发布总数的 60% 以上，越来越来的项目开始使用灰度发布能力，并覆盖了公司最大的两个业务线，灰度能力和稳定性得到了业务的认可和好评。</p><p>但随着业务量的越来越大，pod 实例数的越来越多，也碰到了一些问题：</p><ol><li>团队使用的 Istio 版本为 1.5.0，该版本在 pilot 推送大量 xds 更新时，会导致 envoy 的 readiness 探针检查失败，并再次导致 eds 的大量更新，导致集群波动，该问题社区已经解决，团队也规划升级至 1.7.7 版本解决。</li><li>Pilot 所在机器异常重启后，接入该 pilot 实例的 envoy 无法感知到服务端的异常，需要等待 tcp keepalive 超时并检查失败后才会开始重连至正常的 Istiod，在这段时间内，集群的更新都不会被同步，默认配置需要等待 975 秒，该问题可以通过配置 envoy 的引导配置解决，修改 envoy 默认引导配置 xds-grpc cluster upstream_connection_options 的 tcp_keepalive 配置，保证在 1 分钟内进行重连。</li></ol><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#2aa198>&#34;upstream_connection_options&#34;</span>: {
  <span style=color:#268bd2>&#34;tcp_keepalive&#34;</span>: {
    <span style=color:#268bd2>&#34;keepalive_time&#34;</span>: <span style=color:#2aa198>30</span>,
    <span style=color:#268bd2>&#34;keepalive_probes&#34;</span>: <span style=color:#2aa198>3</span>,
    <span style=color:#268bd2>&#34;keepalive_interval&#34;</span>: <span style=color:#2aa198>5</span>
  }
}
</code></pre></div><h2 id=未来展望>未来展望</h2><p>涂鸦前端基础团队在 2020 年初开始使用 Istio，对于 Istio 丰富的能力和强大的扩展性的使用还在探索阶段，对于未来，我们会着重往两个方向进行探索和挖掘：</p><ol><li>基于当前 Istio 的能力，实现对流量的精细化管理以及服务的降级、熔断，当前对于前端微服务的治理能力缺失，遇上异常场景没有有效手段来保证服务的稳定性</li><li>基于 Istio 的故障注入能力提供故障 use case 并对业务进行注入，提高整体业务系统的容错性，稳定性</li></ol></div></div><h3>推荐阅读</h3><ul><li><a href=/zh/blog/coohom-istio-practice/>酷家乐如何使用 Istio 解决新服务治理系统（Serverless）接入已有成熟自研 Java 服务治理体系</a></li><li><a href=/zh/blog/ebay-istio-practice/>eBay 基于 Istio 的统一流量管理实践</a></li></ul><div class="col-12 blog-post-footer"><hr><a href=/blog/ class=link-grey>← 返回博客列表</a></div></div></section><footer><div class=container><div class="row align-items-center pb-0 footer-logo"><a class=navbar-brand href=/zh><img id=getistio-footer-logo class=img-fluid src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a href=https://www.tetrate.io target=_blank><img id=tetrate-footer-logo class=img-fluid src=/images/tetrate-logo.svg alt="Tetrate Logo"></a></div><div class="py-4 text-center"><div class=mb-4><ul class="list-inline social-icons text-lg-center text-center"><li class=list-inline-item><a href=https://www.tetrate.io/ target=_blank aria-label="Tetrate website"><i class=ti-world></i></a></li><li class=list-inline-item><a href=https://www.twitter.com/tetrateio target=_blank aria-label="Tetrate Twitter account"><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://www.github.com/tetratelabs target=_blank aria-label="Tetrate Github account"><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/tetrate/ target=_blank aria-label="Tetrate LinkedIn account"><i class=ti-linkedin></i></a></li></ul></div><small class=text-white>Support: Join our <a href=https://tetr8.io/tetrate-community target=_blank>#tid-and-getmesh Slack Channel</a> for Community Support</small><br><small class=text-white>License: Tetrate Istio Distro is an open source project and is released under Apache License 2.0 | <a href=https://www.tetrate.io/privacy target=_blank>Privacy Statement</a></small><br><small class=text-white>Official project site of istio is <a href=https://www.istio.io target=_blank>istio.io</a></small><br><small class=text-white>Copyright &copy; 2023 <a href=https://www.tetrate.io target=_blank>Tetrate</a> All rights reserved.</small></div></div></footer><script type=text/javascript>var indexURL="/index.json",baseurl="https://istio.tetratelabs.io//zh"</script><script src=/plugins/jQuery/jquery.min.js></script><script src=/plugins/bootstrap/bootstrap.min.js></script><script src=/plugins/featherlight/featherlight.min.js></script><script src=/plugins/clipboard/clipboard.min.js></script><script src=/plugins/match-height/jquery.matchHeight-min.js></script><script src=/plugins/search/auto-complete.js></script><script src=/plugins/search/search.js></script><script src=/plugins/search/lunr.min.js></script><script src=/plugins/search/fuse.min.js></script><script src=/plugins/search/mark.js></script><script src=/plugins/search/search-page.js></script><script src=/js/script.min.js></script><script src=/js/form.min.js></script><script type=text/javascript src="//js.hsforms.net/forms/v2.js?pre=1"></script><script async defer src=https://buttons.github.io/buttons.js></script></body></html>