<!doctype html><html lang=en-us><head><meta charset=utf-8><title itemprop=name>Istio 1.8: A Virtual Machine Integration Odyssey | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro</title><meta name=twitter:title content="Istio 1.8: A Virtual Machine Integration Odyssey | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta itemprop=name content="Istio 1.8: A Virtual Machine Integration Odyssey | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta name=application-name content="Istio 1.8: A Virtual Machine Integration Odyssey | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta property="og:site_name" content="Tetrate Istio Distro"><meta name=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta itemprop=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta name=twitter:description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:locale" content="en"><meta name=language content="En"><link rel=alternate hreflang=en href=/blog/istio-18-a-virtual-machine-integration-odyssey/><link rel=alternate hreflang=zh href=/zh/blog/istio-18-a-virtual-machine-integration-odyssey/><meta property="og:updated_time" content="2021-01-21T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=/sitemap.xml><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="2021-01-21T00:00:00Z"><meta property="article:published_time" content="2021-01-21T00:00:00Z"><meta property="og:article:author" content="[ jimmy song](https jimmysong.io)"><meta property="article:author" content="[ jimmy song](https jimmysong.io)"><meta name=author content="[ jimmy song](https jimmysong.io)"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Istio 1.8: A Virtual Machine Integration Odyssey","author":{"@type":"Person","name":"https:\/\/github.com\/tetratelabs\/getmesh"},"datePublished":"2021-01-21","description":"In this article, I’ll give you an overview of Istio‘s history of virtual machine integration support. ","wordCount":1583,"mainEntityOfPage":"True","dateModified":"2021-01-21","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Tetrate Istio Distro | Simple, safe enterprise-grade Istio","logo":{"@type":"imageObject","url":"https://getistio.io/images/getistio-by-tetrate-logo.png"}}}</script><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@tetrateio"><meta name=twitter:creator content="@tetrateio"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-P3J9XNBME4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-P3J9XNBME4')</script><link rel=preload href=/plugins/themify-icons/themify-icons.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css></noscript><link rel=preload href=/plugins/search/auto-complete.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/search/auto-complete.css></noscript><link rel=preload href=/plugins/featherlight/featherlight.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/featherlight/featherlight.min.css></noscript><link rel=preload href=/css/bootstrap/bootstrap.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css></noscript><link rel=preload href=/scss/style.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/scss/style.css></noscript><link rel="shortcut icon" href=/images/getistio-favicon.png type=image/x-icon><link rel=icon href=/images/getistio-favicon.png type=image/x-icon><meta property="og:title" content="Istio 1.8: A Virtual Machine Integration Odyssey"><meta property="og:description" content="In this article, I’ll give you an overview of Istio‘s history of virtual machine integration support. "><meta property="og:type" content="article"><meta property="og:url" content="https://istio.tetratelabs.io/blog/istio-18-a-virtual-machine-integration-odyssey/"><meta property="og:image" content="https://istio.tetratelabs.io/images/twitter-card-new.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-01-21T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-21T00:00:00+00:00"><script async defer src=/js/turbolinks.min.js></script></head><body><header class="sticky-top navigation"><div class=my-container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><div class=navbar-brand-container><a class=navbar-brand href=/><img class="img-fluid logo-width" src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a class=github-button href=https://github.com/tetratelabs/getistio data-icon=octicon-star aria-label="Star tetratelabs/getmesh on GitHub">Star</a></div><button aria-label=Menu class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h4 text-white"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto align-items-center"><li class=nav-item><a class=nav-link href=/getmesh-cli/>Docs</a></li><li class=nav-item><a class=nav-link href=/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=/community-events/>Community</a></li><li class=nav-item><a class=nav-link href=https://academy.tetrate.io target=_blank>Training</a></li><li class=nav-item><a class=nav-link href=https://func-e.io/ target=_blank>func-e</a></li><li class=nav-item><a class=nav-link href=https://www.istio.io/ target=_blank>Istio.io</a></li><li class=nav-link><select class=nav-item id=select-language onchange="location=this.value"><option id=en value=/blog/istio-18-a-virtual-machine-integration-odyssey/ selected>En</option><option id=zh value=/zh/blog/istio-18-a-virtual-machine-integration-odyssey/>中文</option></select></li></ul><div class="d-lg-none d-block"><a href=/download class="btn btn-sm btn-primary ml-lg-4">download</a></div></div><div class="d-lg-flex d-none"><a href=/download class="btn btn-sm btn-primary ml-lg-4">Download</a></div></nav></div></header><section class="py-5 blog-individual"><div class=container><div class="row mt-0 mb-0 justify-content-center"><div class=col-12><a href=../ class=link-grey>← Back to Blog</a><hr></div><div class="col-sm-9 mt-3"><h1>Istio 1.8: A Virtual Machine Integration Odyssey</h1><p class="blog-date mt-3"><span class=author-info>by <a href=https://jimmysong.io>Jimmy Song</a></span>
<span>on Jan 21, 2021</span>
/ 7 min read</p><div class="article-tags mb-4"><span class="mr-3 single-tag"><a href=https://istio.tetratelabs.io/tags/vm/>VM</a></span></div></div></div><div class="row justify-content-center mt-0 blog-content"><div class=col-sm-9><p>In this article, I’ll give you an overview of <a href=https://istio.io/>Istio</a>‘s history of virtual machine integration support. In particular, the introduction of the smart DNS proxy and WorkloadGroup in Istio 1.8, which makes virtual machines and containers equivalent at the resource abstraction level.</p><p>I will show you a tumultuous odyssey of Istio’s virtual machine integration. Tetrate, the enterprise service mesh company that made pushing Istio to run everywhere part of its founding mission, has used VM features extensively in customer deployments and has been instrumental in pushing VMs to Istio upstream.</p><h2 id=preface>Preface</h2><p>In my <a href=https://thenewstack.io/how-to-integrate-virtual-machines-into-istio-service-mesh/>previous article</a>, I talked about how Istio 1.7 supported virtual machines. But at that time, late October, virtual machines were still not seamlessly integrated into Istio — there was still a lot of manual work required. Now, Istio 1.8 has added WorkloadGroup and smart DNS proxy, which allows non-Kubernetes workloads like VMs to become first-class citizens in Istio — just like pods.</p><p>With or without a sidecar installed for virtual machines, until 1.7 you could not resolve the DNS name of a Kubernetes service unless a kube-external DNS was configured — which is the last piece of virtual machine integration in Istio. This shortcoming has finally been fixed in Istio 1.8.</p><h2 id=why-is-virtual-machine-support-important>Why Is Virtual Machine Support Important?</h2><p>In the process of migrating our applications to cloud native architectures and continuously containerizing them, we will go through three phases as shown in the figure below.</p><p><img src="https://i1.wp.com/www.tetrate.io/wp-content/uploads/2021/01/cloud-native-stages.png?resize=617%2C183&ssl=1" alt="Cloud Native Stages"></p><ul><li>Stage 1: All applications are deployed on virtual machines</li><li>Stage 2: Applications are deployed on both virtual machines and containers, are migrating from virtual machines to containers, and are using Kubernetes to manage containers.</li><li>Stage 3: All applications are deployed in containers first, using Kubernetes to manage containers and Istio to manage service-to-service communication.</li></ul><p>The above diagram is artificially simplified: in reality, there might be multiple hybrid clouds, multiple regions, multiple clusters, etc. Plus, at stage 3 containers and virtual machines may remain in long-term coexistence, but the trend of containerization remains unchanged.</p><h2 id=istios-history-of-virtual-machine-support>Istio’s History of Virtual Machine Support</h2><p>Istio’s support for virtual machines is a long process, an odyssey of sorts.</p><h3 id=02-istio-mesh-expansion>0.2: Istio Mesh Expansion</h3><p>As of version 0.2, Istio added virtual machines to the Mesh via <a href=https://istio.io/v0.2/docs/setup/kubernetes/mesh-expansion.html>Istio Mesh Expansion</a>, provided that the following prerequisites were met.</p><ul><li>Virtual machines must have direct access to the application’s pods via IP address, which requires a flat network between the container and the VM via VPC or VPN; and virtual machines do not need access to the Cluster IP, but rather direct access to the service’s endpoints.</li><li>Virtual machines must have access to Istio’s control plane services (Pilot, Mixer, CA, now being integrated as Istiod), which can expose the control plane endpoints to virtual machines by deploying load balancers in the Istio Mesh.</li><li>(optional) the virtual machine has access to the DNS server inside the Mesh (deployed in Kubernetes).</li></ul><p>The steps to integrate a virtual machine are as follows.</p><ol><li>Create an internal load balancer for the Istio control plane service and the DNS service for the Kubernetes cluster.</li><li>Generate a configuration file for the Istio Service CIDR, Service Account token, security certificate, and IP of the Istio Control Plane Service (the IP exposed through the Internal Load Balancer) and send it to the virtual machine.</li><li>Setup the Istio component, dnsmaq (for DNS discovery), in the virtual machine; so that the virtual machine can access the services in the mesh using FQDN, to ensure that the virtual machine can correctly resolve the Cluster IP of the services in the mesh.</li><li>To run the service in a virtual machine, you need to configure the sidecar, add inbound ports to be intercepted, then restart Istio and also run istioctl to register the service.</li></ol><p>The following figure shows the detailed flow from integrating a virtual machine to accessing services in the virtual machine in a mesh.</p><p><img src="https://i0.wp.com/cdn.thenewstack.io/media/2021/01/c2568250-image1-884x1024.png?resize=640%2C741&ssl=1" alt="Integrating VMs and accessing services"></p><ol><li>The DNS is hijacked by dnsmasq deployed in the virtual machine, which allows it to correctly obtain the Cluster IP of the Istio service (Kubernetes’ built-in DNS).</li><li>Access to Kubernetes’ built-in DNS service (which is exposed outside the cluster via the Internal Load Balancer and can be accessed directly).</li><li>Return the Cluster IP resolved by <code>productpage.bookinfo . svc. cluster . local</code>, noting that the IP address is not directly accessible, but failure to be DNS resolved will result in a failed VM request for the service.</li><li>The virtual machine’s call to services in a mesh is hijacked by the sidecar proxy.</li><li>Since the proxy is connected to the Istio control plane, the endpoints of the service can be queried via xDS, so traffic will be forwarded to one of the endpoints.</li><li>To access VM services in mesh, you need to manually add VM services to mesh using the istioctl register command, which essentially registers the VM services to the service and endpoint in Kubernetes.</li><li>Services in the mesh can be accessed using the VM-registered service name (FQDN, e.g. <code>mysql.vm.svc.cluster.local</code>).</li></ol><p>The above Istio support for virtual machines continued with Istio 1.0, which introduced a new API <a href=https://istio.io/latest/docs/reference/config/networking/service-entry/>ServiceEntry</a> with Istio 1.1, that allows additional entries to be added to Istio’s internal service registry so that services in the mesh can access/route to these manually specified services. The istioctl register command is no longer needed and will be deprecated in Istio 1.9.</p><p>The istioctl experimental add-to-mesh command has been added to Istio 1.5 to add services from a virtual machine to a mesh, and it works just like the istioctl register.</p><h3 id=16-to-17-new-resource-abstractions>1.6 to 1.7: New Resource Abstractions</h3><p>Istio introduced a new resource type, <a href=https://istio.io/latest/docs/reference/config/networking/workload-entry/>WorkloadEntry</a>, in traffic management from <a href=https://istio.io/latest/news/releases/1.6.x/announcing-1.6/>version 1.6</a>, to abstract virtual machines so that they can be added to the mesh as equivalent loads to the pods in Kubernetes; with traffic management, security management, observability, etc. The mesh configuration process for virtual machines is simplified with WorkloadEntry, which selects multiple workload entries and Kubernetes pods based on the label selector specified in the service entry.</p><p>Istio 1.8 adds a resource object for <a href=http://istio.io/latest/docs/reference/config/networking/workload-group/>WorkloadGroup</a> that provides a specification that can include both virtual machines and Kubernetes workloads, designed to mimic the existing sidecar injection and deployment specification model for Kubernetes workloads to bootstrap Istio agents on the VMs.</p><p>Below is a comparison of resource abstraction levels for virtual machines versus workloads in Kubernetes.</p><p>From the above diagram, we can see that for virtual machine workloads there is a one-to-one correspondence with the workloads in Kubernetes.</p><p>Everything seems perfect at this point. However, exposing the DNS server in the Kubernetes cluster directly is a big <a href=https://blog.aquasec.com/dns-spoofing-kubernetes-clusters>security risk</a>, so we usually manually write the domain name and Cluster IP pair of the service the virtual machine needs to access to the local /etc/hosts — but this is not practical for a distributed cluster with a large number of nodes.</p><p>The process of accessing the services inside mesh by configuring the local /etc/hosts of the virtual machine is shown in the following figure.</p><p><img src="https://i2.wp.com/cdn.thenewstack.io/media/2021/01/4bedb3a9-image4-933x1024.png?resize=640%2C702&ssl=1" alt="Accessing services inside the mesh"></p><ol><li>Registration of services in the virtual machine into the mesh.</li><li>Manually write the domain name and Cluster IP pairs of the service to be accessed to the local /etc/hosts file in the virtual machine.</li><li>Cluster IP where the virtual machine gets access to the service.</li><li>The traffic is intercepted by the sidecar proxy and the endpoint address of the service to be accessed is resolved by Envoy.</li><li>Access to designated endpoints of the service.</li></ol><p>In Kubernetes, we generally use the Service object for service registration and discovery; each service has a separate DNS name that allows applications to call each other by using the service name. We can use ServiceEntry to register a service in a virtual machine into Istio’s service registry, but a virtual machine cannot access a DNS server in a Kubernetes cluster to get the Cluster IP if the DNS server is not exposed externally to the mesh, which causes the virtual machine to fail to access the services in the mesh. Wouldn’t the problem be solved if we could add a| Tables | Are | Cool |</p><table><thead><tr><th>Items</th><th style=text-align:center>Kubernetes</th><th style=text-align:right>Virtual Machine</th></tr></thead><tbody><tr><td>Basic schedule unit</td><td style=text-align:center>Pod</td><td style=text-align:right>WorkloadEntry</td></tr><tr><td>Component</td><td style=text-align:center>Deployment</td><td style=text-align:right>WorkloadGroup</td></tr><tr><td>Service register and discovery</td><td style=text-align:center>Service</td><td style=text-align:right>ServiceEntry</td></tr></tbody></table><p>sidecar to the virtual machine that would transparently intercept DNS requests and get the Cluster IP of all services in the mesh, similar to the role of dnsmasq in Figure 1?</p><h3 id=as-of-istio-18--smart-dns-proxy>As of Istio 1.8 — Smart DNS Proxy</h3><p>With the introduction of smart <a href=https://cloudnative.to/blog/istio-dns-proxy/>DNS proxy</a> in Istio 1.8, virtual machines can access services within the mesh without the need to configure /etc/hosts, as shown in the following figure.</p><p><img src="https://i0.wp.com/cdn.thenewstack.io/media/2021/01/484de469-image2-884x1024.png?resize=640%2C741&ssl=1" alt="Access services without /etc/hosts configuration"></p><p>The Istio agent on the sidecar will come with a cached DNS proxy dynamically programmed by Istiod. DNS queries from the application are transparently intercepted and served by the Istio proxy in the pod or VM, with the response to DNS query requests, enabling seamless access from the virtual machine to the service mesh.</p><p>The WorkloadGroup and smart DNS proxy introduced in Istio 1.8 provide powerful support for virtual machine workloads, making legacy applications deployed in virtual machines fully equivalent to pods in Kubernetes.</p><h2 id=summary>Summary</h2><p>In this odyssey of Istio’s virtual machine support, we can see the gradual realization of unified management of virtual machines and pods — starting with exposing the DNS server in the mesh and setting up dnsmasq in the virtual machine, and ending with using smart DNS proxies and abstracting resources such as <code>WorkloadEntry</code>, <code>WorkloadGroup</code> and <code>ServiceEntry</code>. This article only focuses on the single cluster situation, which is not enough to be used in real production. We also need to deal with security, multicluster, multitenancy, etc.</p></div></div><div class="col-12 blog-post-footer"><hr><a href=/blog/ class=link-grey>← Back to Blog</a></div></div></section><footer><div class=container><div class="row align-items-center pb-0 footer-logo"><a class=navbar-brand href=/><img id=getistio-footer-logo class=img-fluid src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a href=https://www.tetrate.io target=_blank><img id=tetrate-footer-logo class=img-fluid src=/images/tetrate-logo.svg alt="Tetrate Logo"></a></div><div class="py-4 text-center"><div class=mb-4><ul class="list-inline social-icons text-lg-center text-center"><li class=list-inline-item><a href=https://www.tetrate.io/ target=_blank aria-label="Tetrate website"><i class=ti-world></i></a></li><li class=list-inline-item><a href=https://www.twitter.com/tetrateio target=_blank aria-label="Tetrate Twitter account"><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://www.github.com/tetratelabs target=_blank aria-label="Tetrate Github account"><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/tetrate/ target=_blank aria-label="Tetrate LinkedIn account"><i class=ti-linkedin></i></a></li></ul></div><small class=text-white>Support: Join our <a href=https://tetr8.io/tetrate-community target=_blank>#tid-and-getmesh Slack Channel</a> for Community Support</small><br><small class=text-white>License: Tetrate Istio Distro is an open source project and is released under Apache License 2.0 | <a href=https://www.tetrate.io/privacy target=_blank>Privacy Statement</a></small><br><small class=text-white>Official project site of istio is <a href=https://www.istio.io target=_blank>istio.io</a></small><br><small class=text-white>Copyright &copy; 2023 <a href=https://www.tetrate.io target=_blank>Tetrate</a> All rights reserved.</small></div></div></footer><script type=text/javascript>var indexURL="/index.json",baseurl="https://istio.tetratelabs.io/"</script><script src=/plugins/jQuery/jquery.min.js></script><script src=/plugins/bootstrap/bootstrap.min.js></script><script src=/plugins/featherlight/featherlight.min.js></script><script src=/plugins/clipboard/clipboard.min.js></script><script src=/plugins/match-height/jquery.matchHeight-min.js></script><script src=/plugins/search/auto-complete.js></script><script src=/plugins/search/search.js></script><script src=/plugins/search/lunr.min.js></script><script src=/plugins/search/fuse.min.js></script><script src=/plugins/search/mark.js></script><script src=/plugins/search/search-page.js></script><script src=/js/script.min.js></script><script src=/js/form.min.js></script><script type=text/javascript src="//js.hsforms.net/forms/v2.js?pre=1"></script><script async defer src=https://buttons.github.io/buttons.js></script></body></html>