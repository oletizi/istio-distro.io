<!doctype html><html lang=en-us><head><meta charset=utf-8><title itemprop=name>How to set up Istio with GetMesh on GKE | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro</title><meta name=twitter:title content="How to set up Istio with GetMesh on GKE | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta itemprop=name content="How to set up Istio with GetMesh on GKE | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta name=application-name content="How to set up Istio with GetMesh on GKE | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta property="og:site_name" content="Tetrate Istio Distro"><meta name=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta itemprop=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta name=twitter:description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:locale" content="en"><meta name=language content="En"><link rel=alternate hreflang=en href=/blog/how-to-set-up-istio-with-getistio-on-gke/><link rel=alternate hreflang=zh href=/zh/blog/how-to-set-up-istio-with-getistio-on-gke/><meta property="og:updated_time" content="2021-02-07T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=/sitemap.xml><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="2021-02-07T00:00:00Z"><meta property="article:published_time" content="2021-02-07T00:00:00Z"><meta property="og:article:author" content="[ jimmy song](https jimmysong.io)"><meta property="article:author" content="[ jimmy song](https jimmysong.io)"><meta name=author content="[ jimmy song](https jimmysong.io)"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"How to set up Istio with GetMesh on GKE","author":{"@type":"Person","name":"https:\/\/github.com\/tetratelabs\/getmesh"},"datePublished":"2021-02-07","description":"This article will start by taking you through a hands-on installation and use of GetMesh on GKE.","wordCount":1208,"mainEntityOfPage":"True","dateModified":"2021-02-07","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Tetrate Istio Distro | Simple, safe enterprise-grade Istio","logo":{"@type":"imageObject","url":"https://getistio.io/images/getistio-by-tetrate-logo.png"}}}</script><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@tetrateio"><meta name=twitter:creator content="@tetrateio"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-P3J9XNBME4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-P3J9XNBME4')</script><link rel=preload href=/plugins/themify-icons/themify-icons.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css></noscript><link rel=preload href=/plugins/search/auto-complete.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/search/auto-complete.css></noscript><link rel=preload href=/plugins/featherlight/featherlight.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/featherlight/featherlight.min.css></noscript><link rel=preload href=/css/bootstrap/bootstrap.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css></noscript><link rel=preload href=/scss/style.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/scss/style.css></noscript><link rel="shortcut icon" href=/images/getistio-favicon.png type=image/x-icon><link rel=icon href=/images/getistio-favicon.png type=image/x-icon><meta property="og:title" content="How to set up Istio with GetMesh on GKE"><meta property="og:description" content="This article will start by taking you through a hands-on installation and use of GetMesh on GKE."><meta property="og:type" content="article"><meta property="og:url" content="https://istio.tetratelabs.io/blog/how-to-set-up-istio-with-getistio-on-gke/"><meta property="og:image" content="https://istio.tetratelabs.io/images/twitter-card-new.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-02-07T00:00:00+00:00"><meta property="article:modified_time" content="2021-02-07T00:00:00+00:00"><script async defer src=/js/turbolinks.min.js></script></head><body><header class="sticky-top navigation"><div class=my-container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><div class=navbar-brand-container><a class=navbar-brand href=/><img class="img-fluid logo-width" src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a class=github-button href=https://github.com/tetratelabs/getistio data-icon=octicon-star aria-label="Star tetratelabs/getmesh on GitHub">Star</a></div><button aria-label=Menu class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h4 text-white"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto align-items-center"><li class=nav-item><a class=nav-link href=/getmesh-cli/>Docs</a></li><li class=nav-item><a class=nav-link href=/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=/community-events/>Community</a></li><li class=nav-item><a class=nav-link href=https://academy.tetrate.io target=_blank>Training</a></li><li class=nav-item><a class=nav-link href=https://func-e.io/ target=_blank>func-e</a></li><li class=nav-item><a class=nav-link href=https://www.istio.io/ target=_blank>Istio.io</a></li><li class=nav-link><select class=nav-item id=select-language onchange="location=this.value"><option id=en value=/blog/how-to-set-up-istio-with-getistio-on-gke/ selected>En</option><option id=zh value=/zh/blog/how-to-set-up-istio-with-getistio-on-gke/>中文</option></select></li></ul><div class="d-lg-none d-block"><a href=/download class="btn btn-sm btn-primary ml-lg-4">download</a></div></div><div class="d-lg-flex d-none"><a href=/download class="btn btn-sm btn-primary ml-lg-4">Download</a></div></nav></div></header><section class="py-5 blog-individual"><div class=container><div class="row mt-0 mb-0 justify-content-center"><div class=col-12><a href=../ class=link-grey>← Back to Blog</a><hr></div><div class="col-sm-9 mt-3"><h1>How to set up Istio with GetMesh on GKE</h1><p class="blog-date mt-3"><span class=author-info>by <a href=https://jimmysong.io>Jimmy Song</a></span>
<span>on Feb 7, 2021</span>
/ 5 min read</p><div class="article-tags mb-4"><span class="mr-3 single-tag"><a href=https://istio.tetratelabs.io/tags/installation/>installation</a></span>
<span class="mr-3 single-tag"><a href=https://istio.tetratelabs.io/tags/gke/>GKE</a></span></div></div></div><div class="row justify-content-center mt-0 blog-content"><div class=col-sm-9><p>GetMesh is a CLI for Istio distributions open sourced by Tetrate. It mainly solves the following problems of Istio.</p><ul><li>Istio lifecycle management</li><li>Tested and safe Istio configurations</li><li>Native integrations into the computing environment</li><li>Learning curve and ongoing support</li></ul><p>To learn more about GetMesh, please visit <a href=https://istio.tetratelabs.io>https://istio.tetratelabs.io</a></p><p>This article will start by taking you through a hands-on installation and use of GetMesh on GKE, including:</p><ul><li>Installing Istio 1.7 on GKE</li><li>Adding a virtual machine to the mesh</li><li>Deploying the Bookinfo example</li><li>Integrating a virtual machine for testing</li><li>Upgrading Istio to 1.8</li></ul><p>From the above, you will learn about Istio&rsquo;s deployment architecture, basic functionality, and operation.</p><p>This blog is only for Istio 1.7, for 1.8 the steps to integrate a virtual machine have changed, please refer to the <a href=https://istio.io/latest/docs/setup/install/virtual-machine/>Istio documentation</a>.</p><h2 id=prerequisite>Prerequisite</h2><p>In order to complete the do-it-yourself process, you will need to prepare the following environment.</p><ul><li>A Google Cloud account with a sufficient balance in it</li><li>A local installation of the <code>gcloud</code> tool</li></ul><h2 id=setup-istio>Setup Istio</h2><p>Let’s set up Istio 1.7.5 with GetMesh.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>curl -sL https://istio.tetratelabs.io/getmesh/install.sh | bash
getmesh fetch 1.7.5
</code></pre></div><p>Setup the <a href=https://istio.io/latest/docs/setup/getting-started/>demo profile</a>（including Ingress gateway, egress gateway and Istiod）:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>getmesh istioctl install --set profile=demo --set values.global.meshExpansion.enabled=true
Detected that your cluster does not support third party JWT authentication. Falling back to less secure first party JWT. See https://istio.io/docs/ops/best-practices/security/#configure-third-party-service-account-tokens for details.
✔ Istio core installed
✔ Istiod installed
✔ Ingress gateways installed
✔ Egress gateways installed
✔ Installation complete
</code></pre></div><p>To see the pods under <code>istio-system</code> namespace:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>kubectl get pod -n=istio-system
NAME                                   READY   STATUS   RESTARTS   AGE
istio-egressgateway-695f5944d8-wdk6s    1/1     Running   0         67s
istio-ingressgateway-5c697d4cd7-4cgq7   1/1     Running   0         67s
istiod-59747cbfdd-sbffx                 1/1     Running   0         106s
</code></pre></div><p>Enable sidecar auto injection:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl label namespace bookinfo istio-injection<span style=color:#719e07>=</span>enabled
</code></pre></div><p>Deploy<a href=https://istio.io/latest/docs/examples/bookinfo/> Bookinfo </a>sample:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>kubectl create ns bookinfo
kubectl apply -n bookinfo -f samples/bookinfo/platform/kube/bookinfo.yaml
service/details created
serviceaccount/bookinfo-details created
deployment.apps/details-v1 created
service/ratings created
serviceaccount/bookinfo-ratings created
deployment.apps/ratings-v1 created
service/reviews created
serviceaccount/bookinfo-reviews created
deployment.apps/reviews-v1 created
deployment.apps/reviews-v2 created
deployment.apps/reviews-v3 created
service/productpage created
serviceaccount/bookinfo-productpage created
deployment.apps/productpage-v1 created
</code></pre></div><p>Verify the deployment complete.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl <span style=color:#b58900>exec</span> <span style=color:#2aa198>&#34;</span><span style=color:#719e07>$(</span>kubectl get pod -n bookinfo -l <span style=color:#268bd2>app</span><span style=color:#719e07>=</span>ratings -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#719e07>)</span><span style=color:#2aa198>&#34;</span> -n bookinfo -c ratings -- curl -s productpage:9080/productpage | grep -o <span style=color:#2aa198>&#34;&lt;title&gt;.*&lt;/title&gt;&#34;</span>
</code></pre></div><p>Normally you will see a display that looks like this:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>&lt;title&gt;Simple Bookstore App&lt;/title&gt;
</code></pre></div><p>Enable the access from outside of the mesh:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl -n bookinfo apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
<span style=color:#b58900>export</span> <span style=color:#268bd2>INGRESS_PORT</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].nodePort}&#39;</span><span style=color:#719e07>)</span>
<span style=color:#b58900>export</span> <span style=color:#268bd2>SECURE_INGRESS_PORT</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.spec.ports[?(@.name==&#34;https&#34;)].nodePort}&#39;</span><span style=color:#719e07>)</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$INGRESS_PORT</span><span style=color:#2aa198>&#34;</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$SECURE_INGRESS_PORT</span><span style=color:#2aa198>&#34;</span>
<span style=color:#b58900>export</span> <span style=color:#268bd2>INGRESS_HOST</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span>kubectl -n istio-system get service istio-ingressgateway -o <span style=color:#268bd2>jsonpath</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#719e07>)</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$INGRESS_HOST</span><span style=color:#2aa198>&#34;</span>
<span style=color:#b58900>export</span> <span style=color:#268bd2>GATEWAY_URL</span><span style=color:#719e07>=</span><span style=color:#268bd2>$INGRESS_HOST</span>:<span style=color:#268bd2>$INGRESS_PORT</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#268bd2>$GATEWAY_URL</span><span style=color:#2aa198>&#34;</span>
</code></pre></div><p>Apply the default DestinationRule.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl apply -n bookinfo -f samples/bookinfo/networking/destination-rule-all.yaml
</code></pre></div><h2 id=adding-a-virtual-machine-to-istio-mesh>Adding a virtual machine to Istio mesh</h2><p>We will install MySQL on the VM, and configure it as a backend for the ratings service. Eventually, the service topology diagram for the <a href=https://istio.io/latest/docs/examples/bookinfo/>bookinfo</a> example will look something like this.</p><p><img src=008eGmZEly1gngfmhrx7aj316k0u079c.jpg alt="Bookinfo sample with VM"></p><p>We will create a virtual machine in Google cloud and add it to the Istio Mesh. Assuming the name of the VM instance is instance-1, first create a certificate for the VM.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl create secret generic cacerts -n istio-system <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    --from-file<span style=color:#719e07>=</span>samples/certs/ca-cert.pem <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    --from-file<span style=color:#719e07>=</span>samples/certs/ca-key.pem <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    --from-file<span style=color:#719e07>=</span>samples/certs/root-cert.pem <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    --from-file<span style=color:#719e07>=</span>samples/certs/cert-chain.pem
</code></pre></div><p>Setup Istio mesh expansion.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh istioctl install <span style=color:#cb4b16>\
</span><span style=color:#cb4b16></span>    -f manifests/examples/vm/values-istio-meshexpansion.yaml
</code></pre></div><p>Execute the following command in the Cloud shell to generate the configuration file for the virtual machine expansion.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#268bd2>VM_NAME</span><span style=color:#719e07>=</span>instance-1
<span style=color:#268bd2>VM_NAMESPACE</span><span style=color:#719e07>=</span>vm
<span style=color:#268bd2>WORK_DIR</span><span style=color:#719e07>=</span>vm
<span style=color:#268bd2>SERVICE_ACCOUNT</span><span style=color:#719e07>=</span>instance-1
cat <span style=color:#2aa198>&lt;&lt;EOF&gt; &#34;${WORK_DIR}&#34;/vmintegration.yaml
</span><span style=color:#2aa198>apiVersion: install.istio.io/v1alpha1
</span><span style=color:#2aa198>kind: IstioOperator
</span><span style=color:#2aa198>spec:
</span><span style=color:#2aa198> values:
</span><span style=color:#2aa198>   global:
</span><span style=color:#2aa198>     meshExpansion:
</span><span style=color:#2aa198>       enabled: true
</span><span style=color:#2aa198>EOF</span>
getmesh istioctl install -f <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/vmintegration.yaml
kubectl create namespace <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>VM_NAMESPACE</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
kubectl create serviceaccount <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>SERVICE_ACCOUNT</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span> -n <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>VM_NAMESPACE</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>
<span style=color:#586e75># 1 hour. Note the expiration time, this token is only used during authentication and is not needed later.</span>
<span style=color:#268bd2>tokenexpiretime</span><span style=color:#719e07>=</span><span style=color:#2aa198>3600</span>
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;{&#34;kind&#34;:&#34;TokenRequest&#34;,&#34;apiVersion&#34;:&#34;authentication.k8s.io/v1&#34;,&#34;spec&#34;:{&#34;audiences&#34;:[&#34;istio-ca&#34;],&#34;expirationSeconds&#34;:&#39;</span><span style=color:#268bd2>$tokenexpiretime</span><span style=color:#2aa198>&#39;}}&#39;</span> | kubectl create --raw /api/v1/namespaces/<span style=color:#268bd2>$VM_NAMESPACE</span>/serviceaccounts/<span style=color:#268bd2>$SERVICE_ACCOUNT</span>/token -f - | jq -j <span style=color:#2aa198>&#39;.status.token&#39;</span> &gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/istio-token
kubectl -n <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>VM_NAMESPACE</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span> get configmaps istio-ca-root-cert -o json | jq -j <span style=color:#2aa198>&#39;.&#34;data&#34;.&#34;root-cert.pem&#34;&#39;</span> &gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/root-cert
<span style=color:#268bd2>ISTIO_SERVICE_CIDR</span><span style=color:#719e07>=</span><span style=color:#719e07>$(</span><span style=color:#b58900>echo</span> <span style=color:#2aa198>&#39;{&#34;apiVersion&#34;:&#34;v1&#34;,&#34;kind&#34;:&#34;Service&#34;,&#34;metadata&#34;:{&#34;name&#34;:&#34;tst&#34;},&#34;spec&#34;:{&#34;clusterIP&#34;:&#34;1.1.1.1&#34;,&#34;ports&#34;:[{&#34;port&#34;:443}]}}&#39;</span> | kubectl apply -f - 2&gt;&amp;<span style=color:#2aa198>1</span> | sed <span style=color:#2aa198>&#39;s/.*valid IPs is //&#39;</span><span style=color:#719e07>)</span>
touch <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/cluster.env
<span style=color:#b58900>echo</span> <span style=color:#268bd2>ISTIO_SERVICE_CIDR</span><span style=color:#719e07>=</span><span style=color:#268bd2>$ISTIO_SERVICE_CIDR</span> &gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/cluster.env
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;ISTIO_INBOUND_PORTS=3306,8080&#34;</span> &gt;&gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/cluster.env
touch <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/hosts-addendum
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>INGRESS_HOST</span><span style=color:#2aa198>}</span><span style=color:#2aa198> istiod.istio-system.svc&#34;</span> &gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/hosts-addendum
touch <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/sidecar.env
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;PROV_CERT=/var/run/secrets/istio&#34;</span> &gt;&gt;<span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/sidecar.env
<span style=color:#b58900>echo</span> <span style=color:#2aa198>&#34;OUTPUT_CERTS=/var/run/secrets/istio&#34;</span> &gt;&gt; <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>WORK_DIR</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/sidecar.env
</code></pre></div><p>Import the virtual machine configuration files into the virtual machine instance <code>instance-1</code>.</p><p>Using SSH to login to the virtual machine <code>instance-1</code> and copy the files generated for the Kubernetes cluster and Istio to the <code>$HOME</code> directory of the virtual machine.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo apt -y update
sudo apt -y upgrade
sudo mkdir -p /var/run/secrets/istio
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/root-cert.pem /var/run/secrets/istio/root-cert.pem
sudo  mkdir -p /var/run/secrets/tokens
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/istio-token /var/run/secrets/tokens/istio-token
<span style=color:#586e75># Setup Istio on the VM</span>
curl -LO https://storage.googleapis.com/istio-release/releases/1.7.1/deb/istio-sidecar.deb
sudo dpkg -i istio-sidecar.deb
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/cluster.env /var/lib/istio/envoy/cluster.env
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/sidecar.env /var/lib/istio/envoy/sidecar.env
sudo sh -c <span style=color:#2aa198>&#39;cat $(eval echo ~$SUDO_USER)/hosts-addendum &gt;&gt; /etc/hosts&#39;</span>
sudo cp <span style=color:#2aa198>&#34;</span><span style=color:#2aa198>${</span><span style=color:#268bd2>HOME</span><span style=color:#2aa198>}</span><span style=color:#2aa198>&#34;</span>/root-cert.pem /var/run/secrets/istio/root-cert.pem
sudo mkdir -p /etc/istio/proxy
sudo chown -R istio-proxy /var/lib/istio /etc/certs /etc/istio/proxy /var/run/secrets
</code></pre></div><p>Note: By default the virtual machine&rsquo;s firewall will deny inbound requests to port 3306, we need to configure the firewall rules in the VPC to allow services in mesh to access port 3306 of the virtual machine.</p><p>Now you can start Istio on the virtual machine.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo systemctl start istio
</code></pre></div><h2 id=virtual-machine-integrating-test>Virtual Machine integrating test</h2><p>Install MySQL in a virtual machine and use it as the backend of the service.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo apt-get update <span style=color:#719e07>&amp;&amp;</span> sudo apt-get install -y mariadb-server
sudo mysql
GRANT ALL PRIVILEGES ON *.* TO <span style=color:#2aa198>&#39;root&#39;</span>@<span style=color:#2aa198>&#39;localhost&#39;</span> IDENTIFIED BY <span style=color:#2aa198>&#39;password&#39;</span> WITH GRANT OPTION;
quit;
sudo systemctl restart mysql
curl -q https://raw.githubusercontent.com/istio/istio/release-1.7/samples/bookinfo/src/mysql/mysqldb-init.sql | mysql -u root -ppassword
mysql -u root -ppassword <span style=color:#b58900>test</span> -e <span style=color:#2aa198>&#34;select * from ratings;&#34;</span>
mysql -u root -ppassword <span style=color:#b58900>test</span> -e  <span style=color:#2aa198>&#34;update ratings set rating=5 where reviewid=1;select * from ratings;&#34;</span>
hostname -I
<span style=color:#586e75># If the IP address obtained here is &lt;virtual_machine_ip&gt;</span>
</code></pre></div><p>Register the services in the virtual machine to mesh.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh istioctl experimental add-to-mesh -n vm mysqldb &lt;virtual_machine_ip&gt; mysql:3306
</code></pre></div><p>You will see the following output:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>2020-09-17T11:34:37.740252Z     warn   Got &#39;services &#34;mysqldb&#34; not found&#39; looking up svc &#39;mysqldb&#39; in namespace &#39;vm&#39;, attempting to create it
2020-09-17T11:34:38.111244Z     warn   Got &#39;endpoints &#34;mysqldb&#34; not found&#39; looking up endpoints for &#39;mysqldb&#39; in namespace &#39;vm&#39;, attempting to create them
</code></pre></div><p>Deploy the v2 version of the ratings service, using MySQL as the storage backend.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl apply -n bookinfo -f samples/bookinfo/platform/kube/bookinfo-ratings-v2-mysql-vm.yaml
kubectl apply -n bookinfo -f samples/bookinfo/networking/virtual-service-ratings-mysql-vm.yaml
</code></pre></div><p>Add configurations for DestinationRule, ServiceEntry, and WorkloadEntry for MySQL services deployed on the virtual machine.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: DestinationRule
<span style=color:#268bd2>metadata</span>:
 <span style=color:#268bd2>name</span>: mtls-mysqldb-vm
<span style=color:#268bd2>spec</span>:
 <span style=color:#268bd2>host</span>: mysqldb.vm.svc.cluster.local
 <span style=color:#268bd2>trafficPolicy</span>:
   <span style=color:#268bd2>tls</span>:
     <span style=color:#268bd2>mode</span>: ISTIO_MUTUAL
---
<span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: ServiceEntry
<span style=color:#268bd2>metadata</span>:
 <span style=color:#268bd2>name</span>: mysqldb-vm
<span style=color:#268bd2>spec</span>:
 <span style=color:#268bd2>hosts</span>:
 - mysqldb.vm.svc.cluster.local
 <span style=color:#268bd2>location</span>: MESH_INTERNAL
 <span style=color:#268bd2>ports</span>:
 - <span style=color:#268bd2>number</span>: <span style=color:#2aa198>3306</span>
   <span style=color:#268bd2>name</span>: mysql
   <span style=color:#268bd2>protocol</span>: mysql
 <span style=color:#268bd2>resolution</span>: STATIC
 <span style=color:#268bd2>workloadSelector</span>:
   <span style=color:#268bd2>labels</span>:
     <span style=color:#268bd2>app</span>: mysqldb-vm
---
<span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: WorkloadEntry
<span style=color:#268bd2>metadata</span>:
 <span style=color:#268bd2>name</span>: mysqldb-vm
<span style=color:#268bd2>spec</span>:
 <span style=color:#268bd2>address</span>: &lt;virtual_machine_ip&gt; <span style=color:#586e75>#change to the VM’s IP</span>
 <span style=color:#268bd2>labels</span>:
   <span style=color:#268bd2>app</span>: mysqldb-vm
   <span style=color:#268bd2>instance-id</span>: ubuntu-vm-mariadb
</code></pre></div><h2 id=upgrade-to-isito-18>Upgrade to Isito 1.8</h2><p>On November 19, 2020, Istio 1.8 was released with support for canary and in-place upgrades. Here we will upgrade Istio using the in-place method.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>getmesh fetch --version 1.8
getmesh istioctl upgrade
Confirm to proceed <span style=color:#719e07>[</span>y/N<span style=color:#719e07>]</span>?
</code></pre></div><p>Enter y to confirm the upgrade, and after confirming that the control plane upgrade is complete, let&rsquo;s upgrade the data plane next.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl rollout restart deployment --namespace bookinfo
</code></pre></div><p>Use the command <code>getmesh istioctl proxy-status -n bookinfo</code> to check the version of the proxy and you can see that it has been updated to 1.8.0.</p><h2 id=frequently-used-command>Frequently used command</h2><p>The following are the common commands used in the above operations.</p><p><strong>Use the gcloud command to log in to the Google cloud virtual machine</strong></p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>gcloud compute ssh jimmy@instance-1 --zone<span style=color:#719e07>=</span>us-west2-a
</code></pre></div><p><strong>Cleanup bookinfo sample</strong></p><p>In the root directory of the unpacked istio installation package, execute:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>samples/bookinfo/platform/kube/cleanup.sh
</code></pre></div></div></div><div class="col-12 blog-post-footer"><hr><a href=/blog/ class=link-grey>← Back to Blog</a></div></div></section><footer><div class=container><div class="row align-items-center pb-0 footer-logo"><a class=navbar-brand href=/><img id=getistio-footer-logo class=img-fluid src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a href=https://www.tetrate.io target=_blank><img id=tetrate-footer-logo class=img-fluid src=/images/tetrate-logo.svg alt="Tetrate Logo"></a></div><div class="py-4 text-center"><div class=mb-4><ul class="list-inline social-icons text-lg-center text-center"><li class=list-inline-item><a href=https://www.tetrate.io/ target=_blank aria-label="Tetrate website"><i class=ti-world></i></a></li><li class=list-inline-item><a href=https://www.twitter.com/tetrateio target=_blank aria-label="Tetrate Twitter account"><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://www.github.com/tetratelabs target=_blank aria-label="Tetrate Github account"><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/tetrate/ target=_blank aria-label="Tetrate LinkedIn account"><i class=ti-linkedin></i></a></li></ul></div><small class=text-white>Support: Join our <a href=https://tetr8.io/tetrate-community target=_blank>#tid-and-getmesh Slack Channel</a> for Community Support</small><br><small class=text-white>License: Tetrate Istio Distro is an open source project and is released under Apache License 2.0 | <a href=https://www.tetrate.io/privacy target=_blank>Privacy Statement</a></small><br><small class=text-white>Official project site of istio is <a href=https://www.istio.io target=_blank>istio.io</a></small><br><small class=text-white>Copyright &copy; 2023 <a href=https://www.tetrate.io target=_blank>Tetrate</a> All rights reserved.</small></div></div></footer><script type=text/javascript>var indexURL="/index.json",baseurl="https://istio.tetratelabs.io/"</script><script src=/plugins/jQuery/jquery.min.js></script><script src=/plugins/bootstrap/bootstrap.min.js></script><script src=/plugins/featherlight/featherlight.min.js></script><script src=/plugins/clipboard/clipboard.min.js></script><script src=/plugins/match-height/jquery.matchHeight-min.js></script><script src=/plugins/search/auto-complete.js></script><script src=/plugins/search/search.js></script><script src=/plugins/search/lunr.min.js></script><script src=/plugins/search/fuse.min.js></script><script src=/plugins/search/mark.js></script><script src=/plugins/search/search-page.js></script><script src=/js/script.min.js></script><script src=/js/form.min.js></script><script type=text/javascript src="//js.hsforms.net/forms/v2.js?pre=1"></script><script async defer src=https://buttons.github.io/buttons.js></script></body></html>