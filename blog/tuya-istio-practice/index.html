<!doctype html><html lang=en-us><head><meta charset=utf-8><title itemprop=name>Tuya Smart’s Implementation of an Istio Enterprise-level Production | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro</title><meta name=twitter:title content="Tuya Smart’s Implementation of an Istio Enterprise-level Production | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta itemprop=name content="Tuya Smart’s Implementation of an Istio Enterprise-level Production | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta name=application-name content="Tuya Smart’s Implementation of an Istio Enterprise-level Production | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta property="og:site_name" content="Tetrate Istio Distro"><meta name=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta itemprop=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta name=twitter:description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:locale" content="en"><meta name=language content="En"><link rel=alternate hreflang=en href=/blog/tuya-istio-practice/><link rel=alternate hreflang=zh href=/zh/blog/tuya-istio-practice/><meta property="og:updated_time" content="2021-04-07T10:03:00+0800"><link rel=sitemap type=application/xml title=Sitemap href=/sitemap.xml><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="2021-04-07T10:03:00+0800"><meta property="article:published_time" content="2021-04-07T10:03:00+0800"><meta property="og:article:author" content="Tuya smart front end core technology team"><meta property="article:author" content="Tuya smart front end core technology team"><meta name=author content="Tuya smart front end core technology team"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Tuya Smart’s Implementation of an Istio Enterprise-level Production","author":{"@type":"Person","name":"https:\/\/github.com\/tetratelabs\/getmesh"},"datePublished":"2021-04-07","description":"Istio practice in Tuya.","wordCount":1033,"mainEntityOfPage":"True","dateModified":"2021-04-07","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Tetrate Istio Distro | Simple, safe enterprise-grade Istio","logo":{"@type":"imageObject","url":"https://getistio.io/images/getistio-by-tetrate-logo.png"}}}</script><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@tetrateio"><meta name=twitter:creator content="@tetrateio"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-P3J9XNBME4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-P3J9XNBME4')</script><link rel=preload href=/plugins/themify-icons/themify-icons.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css></noscript><link rel=preload href=/plugins/search/auto-complete.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/search/auto-complete.css></noscript><link rel=preload href=/plugins/featherlight/featherlight.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/featherlight/featherlight.min.css></noscript><link rel=preload href=/css/bootstrap/bootstrap.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css></noscript><link rel=preload href=/scss/style.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/scss/style.css></noscript><link rel="shortcut icon" href=/images/getistio-favicon.png type=image/x-icon><link rel=icon href=/images/getistio-favicon.png type=image/x-icon><meta property="og:title" content="Tuya Smart’s Implementation of an Istio Enterprise-level Production"><meta property="og:description" content="Istio practice in Tuya."><meta property="og:type" content="article"><meta property="og:url" content="https://istio.tetratelabs.io/blog/tuya-istio-practice/"><meta property="og:image" content="https://istio.tetratelabs.io/images/twitter-card-new.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-04-07T10:03:00+08:00"><meta property="article:modified_time" content="2021-04-07T10:03:00+08:00"><script async defer src=/js/turbolinks.min.js></script></head><body><header class="sticky-top navigation"><div class=my-container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><div class=navbar-brand-container><a class=navbar-brand href=/><img class="img-fluid logo-width" src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a class=github-button href=https://github.com/tetratelabs/getistio data-icon=octicon-star aria-label="Star tetratelabs/getmesh on GitHub">Star</a></div><button aria-label=Menu class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h4 text-white"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto align-items-center"><li class=nav-item><a class=nav-link href=/getmesh-cli/>Docs</a></li><li class=nav-item><a class=nav-link href=/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=/community-events/>Community</a></li><li class=nav-item><a class=nav-link href=https://academy.tetrate.io target=_blank>Training</a></li><li class=nav-item><a class=nav-link href=https://func-e.io/ target=_blank>func-e</a></li><li class=nav-item><a class=nav-link href=https://www.istio.io/ target=_blank>Istio.io</a></li><li class=nav-link><select class=nav-item id=select-language onchange="location=this.value"><option id=en value=/blog/tuya-istio-practice/ selected>En</option><option id=zh value=/zh/blog/tuya-istio-practice/>中文</option></select></li></ul><div class="d-lg-none d-block"><a href=/download class="btn btn-sm btn-primary ml-lg-4">download</a></div></div><div class="d-lg-flex d-none"><a href=/download class="btn btn-sm btn-primary ml-lg-4">Download</a></div></nav></div></header><section class="py-5 blog-individual"><div class=container><div class="row mt-0 mb-0 justify-content-center"><div class=col-12><a href=../ class=link-grey>← Back to Blog</a><hr></div><div class="col-sm-9 mt-3"><h1>Tuya Smart’s Implementation of an Istio Enterprise-level Production</h1><p class="blog-date mt-3"><span class=author-info>by Tuya Smart Front-end Core Technology Team</span>
<span>on Apr 7, 2021</span>
/ 5 min read</p><div class="article-tags mb-4"><span class="mr-3 single-tag"><a href=https://istio.tetratelabs.io/tags/istio/>Istio</a></span></div></div></div><div class="row justify-content-center mt-0 blog-content"><div class=col-sm-9><p>An Istio use case of Tuya Smart.</p><h2 id=background>Background</h2><p>As the most active service mesh project at present, Istio provides numerous capabilities, including traffic management, security, and observability. Each capability is necessary for the management, operation, and maintenance of services. Istio&rsquo;s extensive capabilities also bring certain challenges to the operation and maintenance of complex systems. In terms of its capabilities and future scalability, Istio reimagines service management, bringing about new opportunities along with challenges.</p><p>Tuya Smart currently uses Istio control plane version 1.5.0 for its front-end business, allowing access to the Istio control plane by over 700 services and 1,100 pod instances that are responsible for the traffic control and capacity support of the largest business cluster at the front-end of Tuya Smart.</p><h2 id=existing-challenges-faced-by-tuya-smart-in-the-development-process>Existing challenges faced by Tuya Smart in the development process</h2><p>Tuya Smart’s Front-end Core Technology Team began to contact Kubernetes in 2018 and built a Kubernetes-based release platform to serve the front-end business team. However, as the business team grew larger, some issues began to emerge in the development and release process:</p><ul><li>Authentication issues in multi-branch parallel development</li><li>Network issues caused by configuration complexity due to a multi-regional environment</li></ul><p>Initially, we considered letting the business team make adjustments accordingly and deal with it internally. But as more of our teams experienced similar difficulties, we thought that gray release capabilities would be a better solution for these issues in the development and release process. In the daily pre-release environment, multiple branches release multiple grayscale versions, and distribute traffic to different versions according to different headers, ensuring that each feature branch has a separate instance for authentication, and does not affect each other. The online environment provides grayscale capabilities for regression testing and acts as the last line of defense for project quality.</p><p>We investigated a number of solutions and internally referred to the grayscale solutions of other teams. Due to the complexity of implementation and the diversity of capabilities, we began to deploy Istio in the production environment in early 2020. Although integration with Istio has increased the complexity of the system to a certain extent, it has also given us many unexpected benefits.</p><h2 id=issues-resolved-by-istio>Issues resolved by Istio</h2><h3 id=gray-release>Gray Release</h3><p>The gray release capability of the platform is built based on Istio&rsquo;s native resources, <code>VirtualService</code> and <code>DestinationRule</code>.</p><ul><li>Each application released by the platform is marked with two labels: <code>canarytag</code> and <code>stage</code>. <code>stage</code> is used to identify normal releases and gray releases, and the <code>canarytag</code> is used to identify different grayscale versions.</li><li>Every time a grayscale version is released, a corresponding grayscale <code>ReplicaSet</code> instance is created.</li><li>The <code>DestinationRule</code> configuration corresponding to the release carries the label <code>canarytag</code>, <code>stage</code> defines normal releases and different versions of grayscale instances as different instance sets.</li><li>A collection of different instances is distributed by <code>VirtualService</code> according to different headers.</li></ul><p>The figure below shows the configuration information.</p><p><img src=canary.png alt></p><h3 id=traffic-observation-and-irregularity-detection>Traffic observation and irregularity detection</h3><p>We built our monitoring platform based on the community’s native <code>prometheus-operator</code>. Each cluster deploys a separate prometheus-operator and divides it into three aspects according to the target objects to be collected: business, Kubernetes cluster infrastructure, and Istio data plane traffic. We deploy the corresponding business prometheus instance: Kubernetes cluster infrastructure for monitoring the prometheus instance and Istio traffic for monitoring the prometheus instance.</p><p><img src=monitoring.jpg alt></p><p>With Grafana, an overall data plane traffic monitoring system was built to observe traffic.</p><p><img src=flow_market.png alt></p><p>Based on the current monitoring data, the corresponding alert rules are configured, and there are means to detect and discover irregularities and fluctuations in traffic, and deal with them in a timely manner.
sum(envoy_cluster_upstream_cx_active{namespace!=&ldquo;fe-pre&rdquo;}) by (namespace, service) &lt; 1 No available service alert</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini>sum by(namespace, service) (rate(envoy_cluster_upstream_rq_503[1m])) &gt; 0    503 Irregularity alert
sum by(namespace, service) (rate(envoy_cluster_upstream_rq{response_code_class!<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;2xx&#34;}[1m])) != 0  Business irregularity alert</span>
</code></pre></div><h2 id=current-outcomes-and-existing-problems>Current outcomes and existing problems</h2><p>All pod instances of the largest business cluster currently online have been connected to the Istio control plane. Istio controls the overall traffic and has the ability to observe traffic.</p><p><img src=flow.png alt></p><p>The number of grayscale releases accounts for more than 60% of the total number of releases. An increasing number of projects across the company’s two largest business lines have begun to utilize grayscale release capabilities. The grayscale capabilities and their level of stability have been recognized and endorsed by the businesses.</p><p>However, with the increasing business volume and the increasing number of pod instances, some problems have also been encountered:</p><ul><li>The Istio version used by the team is 1.5.0. When the pilot pushes a large number of xds updates, this version will cause Envoy’s readiness probe check to fail, and again cause a large number of eds updates, causing cluster fluctuations. This problem has been resolved by the community and the team also plans to upgrade to version 1.7.7.</li><li>After the pilot machine restarts irregularly, Envoy, which has been connected to the pilot instance, cannot perceive the irregularity of the server. It needs to wait for the tcp keepalive to time out and check for failure before it starts to reconnect to the normal Istiod. During this time, the cluster updates are not synchronized. By default, you must wait for 975 seconds. This problem can be solved by reconfiguring Envoy boot. Modify tcp_keepalive of the Envoy default boot configuration xds-grpc cluster upstream_connection_options to ensure reconnection within 1 minute.</li></ul><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#2aa198>&#34;upstream_connection_options&#34;</span>: {
  <span style=color:#268bd2>&#34;tcp_keepalive&#34;</span>: {
    <span style=color:#268bd2>&#34;keepalive_time&#34;</span>: <span style=color:#2aa198>30</span>,
    <span style=color:#268bd2>&#34;keepalive_probes&#34;</span>: <span style=color:#2aa198>3</span>,
    <span style=color:#268bd2>&#34;keepalive_interval&#34;</span>: <span style=color:#2aa198>5</span>
  }
}
</code></pre></div><h2 id=our-future>Our future</h2><p>The Tuya Front-end Core Technology Team started using Istio in early 2020. We are still exploring Istio&rsquo;s extensive capabilities and its powerful scalability. In the future, we will focus on exploring and testing on two different aspects:</p><ul><li>Refined management of traffic and service degradation and fusing based on the current capabilities of Istio. The current service management capabilities for front-end microservices are deficient and there is no effective means to ensure service stability when encountering irregularity cases.</li><li>Addition of Istio-based fault injection capability to inject fault use cases into services, improving the fault tolerance and stability of the overall business system.</li></ul><p><strong>Author</strong>: Tuya Smart Front-end Core Technology Team (涂鸦智能前端基础技术团队)</p></div></div><h3>See Also</h3><ul><li><a href=/blog/ebay-istio-practice/>An Istio-based Traffic Management Use Case of eBay</a></li><li><a href=/blog/coohom-istio-practice/>How Coohom Uses Istio to Integrate a New Serverless System into its Existing Self-developed Java System</a></li></ul><div class="col-12 blog-post-footer"><hr><a href=/blog/ class=link-grey>← Back to Blog</a></div></div></section><footer><div class=container><div class="row align-items-center pb-0 footer-logo"><a class=navbar-brand href=/><img id=getistio-footer-logo class=img-fluid src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a href=https://www.tetrate.io target=_blank><img id=tetrate-footer-logo class=img-fluid src=/images/tetrate-logo.svg alt="Tetrate Logo"></a></div><div class="py-4 text-center"><div class=mb-4><ul class="list-inline social-icons text-lg-center text-center"><li class=list-inline-item><a href=https://www.tetrate.io/ target=_blank aria-label="Tetrate website"><i class=ti-world></i></a></li><li class=list-inline-item><a href=https://www.twitter.com/tetrateio target=_blank aria-label="Tetrate Twitter account"><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://www.github.com/tetratelabs target=_blank aria-label="Tetrate Github account"><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/tetrate/ target=_blank aria-label="Tetrate LinkedIn account"><i class=ti-linkedin></i></a></li></ul></div><small class=text-white>Support: Join our <a href=https://tetr8.io/tetrate-community target=_blank>#tid-and-getmesh Slack Channel</a> for Community Support</small><br><small class=text-white>License: Tetrate Istio Distro is an open source project and is released under Apache License 2.0 | <a href=https://www.tetrate.io/privacy target=_blank>Privacy Statement</a></small><br><small class=text-white>Official project site of istio is <a href=https://www.istio.io target=_blank>istio.io</a></small><br><small class=text-white>Copyright &copy; 2023 <a href=https://www.tetrate.io target=_blank>Tetrate</a> All rights reserved.</small></div></div></footer><script type=text/javascript>var indexURL="/index.json",baseurl="https://istio.tetratelabs.io/"</script><script src=/plugins/jQuery/jquery.min.js></script><script src=/plugins/bootstrap/bootstrap.min.js></script><script src=/plugins/featherlight/featherlight.min.js></script><script src=/plugins/clipboard/clipboard.min.js></script><script src=/plugins/match-height/jquery.matchHeight-min.js></script><script src=/plugins/search/auto-complete.js></script><script src=/plugins/search/search.js></script><script src=/plugins/search/lunr.min.js></script><script src=/plugins/search/fuse.min.js></script><script src=/plugins/search/mark.js></script><script src=/plugins/search/search-page.js></script><script src=/js/script.min.js></script><script src=/js/form.min.js></script><script type=text/javascript src="//js.hsforms.net/forms/v2.js?pre=1"></script><script async defer src=https://buttons.github.io/buttons.js></script></body></html>