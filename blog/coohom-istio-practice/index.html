<!doctype html><html lang=en-us><head><meta charset=utf-8><title itemprop=name>How Coohom Uses Istio to Integrate a New Serverless System into its Existing Self-developed Java System | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro</title><meta name=twitter:title content="How Coohom Uses Istio to Integrate a New Serverless System into its Existing Self-developed Java System | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta itemprop=name content="How Coohom Uses Istio to Integrate a New Serverless System into its Existing Self-developed Java System | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta name=application-name content="How Coohom Uses Istio to Integrate a New Serverless System into its Existing Self-developed Java System | GetIstio by Tetrate | Simple, safe enterprise-grade Istio distro"><meta property="og:site_name" content="Tetrate Istio Distro"><meta name=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta itemprop=description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta name=twitter:description content="Tetrate Istio Distro project provides a simple, safe, enterprise-grade Istio distro."><meta property="og:locale" content="en"><meta name=language content="En"><link rel=alternate hreflang=en href=/blog/coohom-istio-practice/><link rel=alternate hreflang=zh href=/zh/blog/coohom-istio-practice/><meta property="og:updated_time" content="2021-02-12T10:03:00+0800"><link rel=sitemap type=application/xml title=Sitemap href=/sitemap.xml><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="2021-02-12T10:03:00+0800"><meta property="article:published_time" content="2021-02-12T10:03:00+0800"><meta property="og:article:author" content="Ning luo"><meta property="article:author" content="Ning luo"><meta name=author content="Ning luo"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"How Coohom Uses Istio to Integrate a New Serverless System into its Existing Self-developed Java System","author":{"@type":"Person","name":"https:\/\/github.com\/tetratelabs\/getmesh"},"datePublished":"2021-02-12","description":"Istio practice in Coohom.","wordCount":1421,"mainEntityOfPage":"True","dateModified":"2021-02-12","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"Tetrate Istio Distro | Simple, safe enterprise-grade Istio","logo":{"@type":"imageObject","url":"https://getistio.io/images/getistio-by-tetrate-logo.png"}}}</script><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content="@tetrateio"><meta name=twitter:creator content="@tetrateio"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><meta name=generator content="Hugo 0.85.0"><script async src="https://www.googletagmanager.com/gtag/js?id=G-P3J9XNBME4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-P3J9XNBME4')</script><link rel=preload href=/plugins/themify-icons/themify-icons.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/themify-icons/themify-icons.css></noscript><link rel=preload href=/plugins/search/auto-complete.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/search/auto-complete.css></noscript><link rel=preload href=/plugins/featherlight/featherlight.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/plugins/featherlight/featherlight.min.css></noscript><link rel=preload href=/css/bootstrap/bootstrap.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css></noscript><link rel=preload href=/scss/style.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=/scss/style.css></noscript><link rel="shortcut icon" href=/images/getistio-favicon.png type=image/x-icon><link rel=icon href=/images/getistio-favicon.png type=image/x-icon><meta property="og:title" content="How Coohom Uses Istio to Integrate a New Serverless System into its Existing Self-developed Java System"><meta property="og:description" content="Istio practice in Coohom."><meta property="og:type" content="article"><meta property="og:url" content="https://istio.tetratelabs.io/blog/coohom-istio-practice/"><meta property="og:image" content="https://istio.tetratelabs.io/images/twitter-card-new.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-02-12T10:03:00+08:00"><meta property="article:modified_time" content="2021-02-12T10:03:00+08:00"><script async defer src=/js/turbolinks.min.js></script></head><body><header class="sticky-top navigation"><div class=my-container><nav class="navbar navbar-expand-lg navbar-light bg-transparent"><div class=navbar-brand-container><a class=navbar-brand href=/><img class="img-fluid logo-width" src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a class=github-button href=https://github.com/tetratelabs/getistio data-icon=octicon-star aria-label="Star tetratelabs/getmesh on GitHub">Star</a></div><button aria-label=Menu class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation>
<i class="ti-menu h4 text-white"></i></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav mx-auto align-items-center"><li class=nav-item><a class=nav-link href=/getmesh-cli/>Docs</a></li><li class=nav-item><a class=nav-link href=/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=/community-events/>Community</a></li><li class=nav-item><a class=nav-link href=https://academy.tetrate.io target=_blank>Training</a></li><li class=nav-item><a class=nav-link href=https://func-e.io/ target=_blank>func-e</a></li><li class=nav-item><a class=nav-link href=https://www.istio.io/ target=_blank>Istio.io</a></li><li class=nav-link><select class=nav-item id=select-language onchange="location=this.value"><option id=en value=/blog/coohom-istio-practice/ selected>En</option><option id=zh value=/zh/blog/coohom-istio-practice/>中文</option></select></li></ul><div class="d-lg-none d-block"><a href=/download class="btn btn-sm btn-primary ml-lg-4">download</a></div></div><div class="d-lg-flex d-none"><a href=/download class="btn btn-sm btn-primary ml-lg-4">Download</a></div></nav></div></header><section class="py-5 blog-individual"><div class=container><div class="row mt-0 mb-0 justify-content-center"><div class=col-12><a href=../ class=link-grey>← Back to Blog</a><hr></div><div class="col-sm-9 mt-3"><h1>How Coohom Uses Istio to Integrate a New Serverless System into its Existing Self-developed Java System</h1><p class="blog-date mt-3"><span class=author-info>by Ning Luo</span>
<span>on Feb 12, 2021</span>
/ 6 min read</p><div class="article-tags mb-4"><span class="mr-3 single-tag"><a href=https://istio.tetratelabs.io/tags/istio/>Istio</a></span></div></div></div><div class="row justify-content-center mt-0 blog-content"><div class=col-sm-9><p><a href=coohom.com>Coohom</a> successfully launched its home cloud design platform based on the core technology of distributed parallel computing and multimedia data mining. The platform is committed to the research and development of cloud rendering, cloud design, BIM, VR, AR, AI, and other technologies, in order to achieve the experience of “What You See Is What You Get”. It is an SAAS cloud software service platform that generates a design plan in 5 minutes, a rendering in 10 seconds, and a VR plan with a single click.</p><h3 id=core-issue>Core Issue</h3><p>The fast-growing business needs of the company have led to the launch of serverless facilities supporting various languages in six domestic and overseas Kubernetes clusters. However, the company already has a mature Java service management system of its own that contains thousands of services deployed on the Kubernetes / KVM platform. Given that their service management systems are starkly different, the core issue is how to successfully enable service calls between them, such that the serverless platform can help make product research and development more efficient.</p><h3 id=strategies>Strategies</h3><p>The Istio-based Knative is the mature open-source serverless facility used by Coohom. In the Kubernetes cluster, Istio provides flexible and powerful dynamic routing/traffic management functions, coupled with some related gateway facilities. This has skillfully resolved the difficulties in enabling calls between services under different systems, while also maintaining the high flexibility and availability under Coohom’s current system.</p><h3 id=outcomes>Outcomes</h3><p>With the help of Istio, serverless platform services are seamlessly integrated into the company’s self-developed service management system in the testing, pre-release, and production environments. Mature businesses using Java services do not need to undergo architectural changes. In respect of new businesses on the serverless platform, through languages NodeJS, Python, C++, and Golang, hundreds of services equipped with features such as rapid release and high flexibility can provide efficient production capacities to dozens of business processes.</p><h2 id=introducing-new-technologies-on-mature-and-complex-service-management-platforms>Introducing new technologies on mature and complex service management platforms</h2><p>With many years of experience in back-end services, Coohom has a mature Dubbo-based Java microservice management framework that has been significantly modified according to the company&rsquo;s business needs. The framework is compatible with the hybrid deployment of Kubernetes and KVM. However, as a medium-large innovative start-up company, Coohom has a large number of new business and new products in various departments, and the technical framework and language requirements of businesses (such as the NodeJS service that integrates product design and display requirements with the browser, and the Python and C++ languages that are required by cloud rendering and scientific research departments) constantly evolve. As a result, the language-based approach of embedding JAR packages for service management is no longer capable of meeting the growing business needs.</p><p>Since 2017, Coohom has started to use self-developed or third-party hosted Kubernetes clusters as production-level container facilities, which encompass strong upgrade, maintenance, and problem-solving capabilities. On the Kubernetes platform, Istio uses a sidecar to inject services that are completely decoupled from languages, which is currently the best heterogeneous management plan that uses a multi-development language framework. Next, we will discuss how Istio VirtualService can be used as a bridge of communication between hundreds of serverless services and existing Java microservices.</p><h3 id=the-kfaas-solution--using-istio-virtualservice-to-bridge-communications-with-existing-microservices>The KFaas Solution – Using Istio VirtualService to Bridge Communications with Existing Microservices</h3><p>In Coohom, all traffic from the main website <a href=http://www.coohom.com>www.coohom.com</a> must pass through the Java gateway service site-gateway under the existing service management system for JWT authentication, filtering, and forwarding to the services in the corresponding cluster according to the rules. Under the current management system, the only services that can accept traffic forwarding are Java services. Under this environment, serverless services are only deployed in the same Kubernetes, and HTTP requests matching the <code>/faas/api/</code> rule are subscribed to using the Java services. Then, use SpringCloud zuul to forward the traffic directly to the gateway service in the Istio cluster. (Note that the configuration for cluster-local-gateway is fundamentally the same as that for istio-ingress-gateway. The only difference is that it only accepts traffic from the intranet and can be dynamically scaled according to load.) Lastly, deploy in the cluster used by the serverless service. In this way, the serverless service can be called by the existing management system.</p><p>The following is a business use case of a display platform. The service is deployed in a cluster and consists of two parts.</p><p><img src=008eGmZEly1gnxmlmtms9j32kx0u0n4c.jpg alt="Coohom serverless functions"></p><p><strong>Part 1</strong>: The Knative service deployed in the <code>faas-alpha</code> namespace of the Kubernetes cluster has the same access mode in the cluster as the ordinary Kubernetes service, namely <code>http://saas-showroom.faas-alpha.svc.cluster.local</code></p><p><strong>Part 2</strong>: The routing rules of the Istio VirtualService deployed in the Kubernetes cluster <code>kfaas-system</code> namespace are:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>apiVersion</span>: networking.istio.io/v1alpha3
<span style=color:#268bd2>kind</span>: VirtualService
<span style=color:#268bd2>metadata</span>:
 <span style=color:#268bd2>name</span>: faas-alpha-ns-saas-showroom-ksvc-virtualservice
 <span style=color:#268bd2>namespace</span>: kfaas-system
<span style=color:#268bd2>spec</span>:
 <span style=color:#268bd2>gateways</span>:
 - knative-serving/cluster-local-gateway
 - knative-serving/knative-ingress-gateway
 <span style=color:#268bd2>hosts</span>:
 - faas-alpha-ksvc-gateway.kfaas-system.svc.cluster.local
 <span style=color:#268bd2>http</span>:
 - <span style=color:#268bd2>match</span>:
   - <span style=color:#268bd2>uri</span>:
       <span style=color:#268bd2>prefix</span>: /faas/api/saas/showroom/
   <span style=color:#268bd2>rewrite</span>:
     <span style=color:#268bd2>authority</span>: saas-showroom.faas-alpha.svc.cluster.local
   <span style=color:#268bd2>route</span>:
   - <span style=color:#268bd2>destination</span>:
       <span style=color:#268bd2>host</span>: cluster-local-gateway.istio-system.svc.cluster.local
 <span style=color:#268bd2>weight</span>: <span style=color:#2aa198>100</span>
</code></pre></div><ul><li>The HTTP path prefix matches <code>/faas/api/p/saas/virtual-showroom/</code> (At present, we use the methods of <code>prefix</code> and <code>exact</code>, and the <code>regex</code> matching function will be provided in the future to avoid routing conflicts.)</li><li>The HTTP host must be <code>faas-alpha-ksvc-gateway.kfaas-system.svc.cluster.local</code> (The Kubernetes service is the <code>external-service</code> of <code>cluster-local-gateway</code>. In a non-production environment, use multiple external-services and multiple test environments to share a <code>cluster-local-gateway</code> service under <code>istio-system</code>.)</li><li>Forward the traffic to the target service <code>saas-showroom.faas-alpha.svc.cluster.local</code>.</li><li>Retry, delay, and other rules can be added to improve the robustness of request forwarding in the mesh.</li><li>The percentage set by weight will be used in the future to enhance the traffic management capabilities of blue-green releases.</li></ul><h3 id=calling-existing-java-microservices-using-the-serverless-solution>Calling Existing Java Microservices Using the Serverless Solution</h3><p>Another Java export gateway service is used here. Since the forwarding and subscription rules are already found in the existing service management system, they will not be detailed here. The serverless approach to access another microservice management system through the entry and exit gateways is known as the “east-west gateway”. Although the rules, usage and formats differ across various management systems, they can be integrated through gateway services compatible with both sides. Calling across systems is commonly seen in the industry, and is also used by some of Coohom’s new subsidiaries or departments to promote compatibility.</p><h3 id=the-kfaas-solution-and-version-decoupling-between-istio--knative>The KFaas Solution and Version Decoupling between Istio / Knative</h3><p>In 2018, before the release of Istio’s official version 1.0, we had already started conducting trial runs in the test environment. Since version 1.0, the releases evolved in the following sequence in the production environment: 1.0.6 -> 1.1.7 -> 1.4.6 -> 1.5.4 (partial clusters). As for Knative, its development is as follows: 0.8 -> 0.9 -> 0.14 -> 0.15. New versions of Istio / Knative continue to evolve. However, some of our initial practices, such as writing business-related configurations into the <code>istio-system</code> namespace, have posed enormous challenges during the updates of incompatible versions. With this in mind, we have specially designed a KFaas solution that not only relies on Istio / Knative facilities, but also decouples from its fixed version.</p><p>The <code>kfaas-system</code> namespace includes:</p><ul><li>East-west gateway service for the serverless entry and exit, which can be elastically scaled according to load</li><li>VirtualService configured by serverless dynamic routing</li><li>Ingress configuration of domain name certificate for specific business-related use or intranet use</li></ul><h3 id=business-level-of-istio-virtualservice-in-coohoms-services>Business Level of Istio VirtualService in Coohom’s Services</h3><p>Under the current business level of the testing environment, the number of VirtualServices has reached over 700 by the end of 2020.</p><p><img src=008eGmZEly1gnwd57tavtj313q0u0u0x.jpg alt=Grafana></p><h3 id=the-future-of-service-mesh-with-coohom>The Future of Service Mesh with Coohom</h3><p>Coohom uses the Istio service mesh to integrate service clusters under different service management systems, facilitating the implementation of serverless frameworks. With this powerful set of productivity tools, dozens of business lines of the company, including the products and R&D teams, can now work more efficiently than ever before. Coohom’s success story presents an illustrative use case of the application of cloud-native technologies in an SaaS company.</p><p>As Coohom’s diversified business lines continue to grow in 2021, the demands for heterogeneous services with multilingual frameworks, fine-grained service management systems, and better business infrastructure are expected to rise. These cloud-native technologies powered by Kubernetes / Istio are bound to create lasting value for Coohom.</p><p><strong>Author</strong>: Luo Ning (罗宁), Senior Development Engineer, Coohom Advanced Technology Engineering Team</p></div></div><h3>See Also</h3><ul><li><a href=/blog/ebay-istio-practice/>An Istio-based Traffic Management Use Case of eBay</a></li></ul><div class="col-12 blog-post-footer"><hr><a href=/blog/ class=link-grey>← Back to Blog</a></div></div></section><footer><div class=container><div class="row align-items-center pb-0 footer-logo"><a class=navbar-brand href=/><img id=getistio-footer-logo class=img-fluid src=/images/tetrate-istio-distro-logo.png alt="Tetrate Istio Distro | Simple, safe enterprise-grade Istio"></a>
<a href=https://www.tetrate.io target=_blank><img id=tetrate-footer-logo class=img-fluid src=/images/tetrate-logo.svg alt="Tetrate Logo"></a></div><div class="py-4 text-center"><div class=mb-4><ul class="list-inline social-icons text-lg-center text-center"><li class=list-inline-item><a href=https://www.tetrate.io/ target=_blank aria-label="Tetrate website"><i class=ti-world></i></a></li><li class=list-inline-item><a href=https://www.twitter.com/tetrateio target=_blank aria-label="Tetrate Twitter account"><i class=ti-twitter-alt></i></a></li><li class=list-inline-item><a href=https://www.github.com/tetratelabs target=_blank aria-label="Tetrate Github account"><i class=ti-github></i></a></li><li class=list-inline-item><a href=https://www.linkedin.com/company/tetrate/ target=_blank aria-label="Tetrate LinkedIn account"><i class=ti-linkedin></i></a></li></ul></div><small class=text-white>Support: Join our <a href=https://tetr8.io/tetrate-community target=_blank>#tid-and-getmesh Slack Channel</a> for Community Support</small><br><small class=text-white>License: Tetrate Istio Distro is an open source project and is released under Apache License 2.0 | <a href=https://www.tetrate.io/privacy target=_blank>Privacy Statement</a></small><br><small class=text-white>Official project site of istio is <a href=https://www.istio.io target=_blank>istio.io</a></small><br><small class=text-white>Copyright &copy; 2023 <a href=https://www.tetrate.io target=_blank>Tetrate</a> All rights reserved.</small></div></div></footer><script type=text/javascript>var indexURL="/index.json",baseurl="https://istio.tetratelabs.io/"</script><script src=/plugins/jQuery/jquery.min.js></script><script src=/plugins/bootstrap/bootstrap.min.js></script><script src=/plugins/featherlight/featherlight.min.js></script><script src=/plugins/clipboard/clipboard.min.js></script><script src=/plugins/match-height/jquery.matchHeight-min.js></script><script src=/plugins/search/auto-complete.js></script><script src=/plugins/search/search.js></script><script src=/plugins/search/lunr.min.js></script><script src=/plugins/search/fuse.min.js></script><script src=/plugins/search/mark.js></script><script src=/plugins/search/search-page.js></script><script src=/js/script.min.js></script><script src=/js/form.min.js></script><script type=text/javascript src="//js.hsforms.net/forms/v2.js?pre=1"></script><script async defer src=https://buttons.github.io/buttons.js></script></body></html>